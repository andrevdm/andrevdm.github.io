<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">Hakyll compiler to include working code samples</a></h1>

            <div class="info">
    Posted on February  5, 2018
    
</div>

<p>Ensuring that the code you include in a blog post is up to date and works can be a bit of a pain. Often I’ll change code while writing a post and then I have to find and copy anything that has changed. This is manual and error prone.</p>
<p>Fortunately <a href="https://hackage.haskell.org/package/hakyll">Hakyll</a> is reasonably easy to customise. Here I’ll show one way to write a hakyll compiler to help with this issue.</p>
<h1 id="goal">Goal</h1>
<p>What I wanted was</p>
<ol type="1">
<li>Include code from a git repo</li>
<li>Work with a specific version of the code</li>
<li>Check that the code builds</li>
<li>Check that tests or any other custom actions succeed</li>
<li>Check that the repo is still accessible</li>
</ol>
<h2 id="example-template-markdown">Example template markdown</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb1-1" data-line-number="1">  ---</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  title: testing</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  ---</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  [&lt;code setup.repo&gt;] https://gist.github.com/53e179c4244411493ae1f9deebc3cc3f.git</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  [&lt;code setup.sha&gt;] 5a95ece18ecb248fb745b3e7cb19f5c4d410240f</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  [&lt;code setup.run&gt;] stack init --resolver lts-10.4</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  [&lt;code setup.run&gt;] stack build</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  [&lt;code setup.run&gt;] stack test</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  Some text</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  [&lt;code&gt;] main</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb1-14" data-line-number="14">  more text</a></code></pre></div>
<p>The markdown should be parsed as follows</p>
<ul>
<li><code>[&lt;code setup.repo&gt;]</code> - is the git repo to pull the code from</li>
<li><code>[&lt;code setup.sha&gt;]</code> - is the commit to work with</li>
<li><code>[&lt;code setup.run&gt;]</code> - any number of commands to run in order.</li>
<li><code>[&lt;code&gt;] main</code> - gets the section named <code>main</code> from the code and inserts it as a markdown code block</li>
</ul>
<h2 id="example-haskell-file-with-sections">Example haskell file with sections</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">import</span>           <span class="dt">Protolude</span> <span class="kw">hiding</span> (onException)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">import</span>           <span class="dt">System.FilePath</span> ((&lt;/&gt;))</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.FilePath</span> <span class="kw">as</span> <span class="dt">FP</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.Directory</span> <span class="kw">as</span> <span class="dt">Dir</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">import</span>           <span class="dt">Control.Exception.Safe</span> (onException, throwString)</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">{-! SECTION&lt; main !-}</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">main <span class="fu">=</span> hakyll <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    match <span class="st">&quot;posts/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">        route <span class="fu">$</span> setExtension <span class="st">&quot;html&quot;</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">        compile <span class="fu">$</span> includeCodeCompiler</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">            <span class="fu">&gt;&gt;=</span> renderPandoc </a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">{-! SECTION&gt; main !-}</span></a></code></pre></div>
<ul>
<li><code>{-! SECTION&lt;</code> starts a code section</li>
<li><code>{-! SECTION&gt;</code> ends a code section</li>
<li>The parser will read all sections from all files in the repo, so section names must be unique. The advantage is that you don’t need to worry about finding paths or paths changing later on.</li>
</ul>
<h2 id="result">Result</h2>
<p>When pandoc is run the include compiler will insert the code from the <code>main</code> section and add a title showing the source path (repo relative) and the position (line from &amp; to).</p>
<h6 id="appsite.hs-32-to-37">app/site.hs (32 to 37)</h6>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">main <span class="fu">=</span> hakyll <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    match <span class="st">&quot;posts/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">        route <span class="fu">$</span> setExtension <span class="st">&quot;html&quot;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">        compile <span class="fu">$</span> includeCodeCompiler</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">            <span class="fu">&gt;&gt;=</span> renderPandoc </a></code></pre></div>
<p>Before including the code, the <strong>includeCompiler</strong> will checkout the code and run the commands specified in the template. In the example template above I’m cloning from a github gist that does not have a stack.yaml so I run <code>stack init</code> first. You can use the commands to run tests etc to ensure that your sample code is working 100%. If any action fails, the blog generation is aborted.</p>
<h2 id="constraints">Constraints</h2>
<ol type="1">
<li>I only use markdown, so I’m assuming that all input is markdown</li>
<li>This is not “production” code. I’m doing a lot of work in IO and throwing exceptions to abort on error</li>
<li>It works for me, feel free to use the code and change it to match your needs.</li>
</ol>
<h1 id="code">Code</h1>
<h2 id="customising-hakyll">Customising hakyll</h2>
<p>The <a href="https://jaspervdj.be/hakyll/tutorials.html">hakyll tutorial</a> will give you an idea of how to setup hakyll.</p>
<p>This is a fairly standard match clause to run your posts through pandoc to generate HTML output</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1">    match <span class="st">&quot;posts/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">        route <span class="fu">$</span> setExtension <span class="st">&quot;html&quot;</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">        compile <span class="fu">$</span> pandocCompiler</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">            <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/post.html&quot;</span>    postCtx</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">            <span class="fu">&gt;&gt;=</span> saveSnapshot <span class="st">&quot;content&quot;</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">            <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/default.html&quot;</span> postCtx</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">            <span class="fu">&gt;&gt;=</span> relativizeUrls</a></code></pre></div>
<p>Lets modify this route to use a new compiler named <strong>includeCodeCompiler</strong> and pipe that output through pandoc</p>
<h6 id="site.hs-32-to-39">site.hs (32 to 39)</h6>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1">    match <span class="st">&quot;posts/*&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">        route <span class="fu">$</span> setExtension <span class="st">&quot;html&quot;</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">        compile <span class="fu">$</span> includeCodeCompiler</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">            <span class="fu">&gt;&gt;=</span> renderPandoc</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">            <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/post.html&quot;</span>    postCtx</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">            <span class="fu">&gt;&gt;=</span> saveSnapshot <span class="st">&quot;content&quot;</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">            <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/default.html&quot;</span> postCtx</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">            <span class="fu">&gt;&gt;=</span> relativizeUrls</a></code></pre></div>
<p>The two changes to notice are</p>
<ol type="1">
<li>Call <strong>includeCompiler</strong> rather than <strong>pandocCompiler</strong></li>
<li>The output of <strong>includeCompiler</strong> is passed to <strong>renderPandoc</strong></li>
</ol>
<h2 id="preliminaries">Preliminaries</h2>
<p>Here are the imports I’m using</p>
<h6 id="site.hs-2-to-20">site.hs (2 to 20)</h6>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">import</span>           <span class="dt">Protolude</span> <span class="kw">hiding</span> (onException)</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw">import</span>           <span class="dt">Prelude</span> (<span class="dt">String</span>)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="kw">import</span>           <span class="dt">Data.Map.Strict</span> (<span class="dt">Map</span>)</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Strict</span> <span class="kw">as</span> <span class="dt">Map</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.List</span> <span class="kw">as</span> <span class="dt">Lst</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">Txt</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">Txt</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="kw">import</span>           <span class="dt">Data.Monoid</span> (mappend)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="kw">import</span>           <span class="dt">Hakyll</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.Exit</span> <span class="kw">as</span> <span class="dt">Xit</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.Process</span> <span class="kw">as</span> <span class="dt">Proc</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="kw">import</span>           <span class="dt">System.FilePath</span> ((&lt;/&gt;))</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.FilePath</span> <span class="kw">as</span> <span class="dt">FP</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.Directory</span> <span class="kw">as</span> <span class="dt">Dir</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="kw">import</span>           <span class="dt">Control.Exception.Safe</span> (onException, throwString)</a></code></pre></div>
<p>And a few helper functions for running shell processes and finding files</p>
<h6 id="site.hs-198-to-228">site.hs (198 to 228)</h6>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="ot">runShell' ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">runShell' workingDir cmd <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  putText cmd</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  runShell workingDir cmd <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="dt">Right</span> _ <span class="ot">-&gt;</span> pass</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    <span class="dt">Left</span> e <span class="ot">-&gt;</span> throwString <span class="fu">$</span> Txt.unpack <span class="st">&quot;Error running `&quot;</span> <span class="fu">&lt;&gt;</span> Txt.unpack cmd <span class="fu">&lt;&gt;</span> <span class="st">&quot;` &quot;</span> <span class="fu">&lt;&gt;</span> show e</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="ot">runShell ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">Int</span> ())</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">runShell workingDir cmd <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">  <span class="kw">let</span> p <span class="fu">=</span> Proc.shell <span class="fu">$</span> Txt.unpack cmd</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">  (_, _, _, phandle) <span class="ot">&lt;-</span> Proc.createProcess p { Proc.cwd <span class="fu">=</span> <span class="dt">Just</span> workingDir }</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">  Proc.waitForProcess phandle <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    <span class="dt">Xit.ExitSuccess</span> <span class="ot">-&gt;</span> pure <span class="fu">$</span> <span class="dt">Right</span> ()</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    <span class="dt">Xit.ExitFailure</span> i <span class="ot">-&gt;</span> pure <span class="fu">$</span> <span class="dt">Left</span> i</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="ot">getFilesRec ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> [FilePath]</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">getFilesRec p <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  fs <span class="ot">&lt;-</span> (p <span class="fu">&lt;/&gt;</span>) <span class="fu">&lt;&lt;$&gt;&gt;</span> getFiles p</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">  ds <span class="ot">&lt;-</span> (p <span class="fu">&lt;/&gt;</span>) <span class="fu">&lt;&lt;$&gt;&gt;</span> getDirs p</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">  cs <span class="ot">&lt;-</span> traverse getFilesRec ds</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">  pure <span class="fu">$</span> fs <span class="fu">&lt;&gt;</span> join cs</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="ot">getDirs ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> [FilePath]</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">getDirs p <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">  entries <span class="ot">&lt;-</span> (p <span class="fu">&lt;/&gt;</span>) <span class="fu">&lt;&lt;$&gt;&gt;</span> Dir.listDirectory p</a>
<a class="sourceLine" id="cb7-26" data-line-number="26">  filterM Dir.doesDirectoryExist entries</a>
<a class="sourceLine" id="cb7-27" data-line-number="27"></a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="ot">getFiles ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> [FilePath]</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">getFiles p <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">  entries <span class="ot">&lt;-</span> (p <span class="fu">&lt;/&gt;</span>) <span class="fu">&lt;&lt;$&gt;&gt;</span> Dir.listDirectory p</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">  filterM Dir.doesFileExist entries</a></code></pre></div>
<h2 id="the-includecodecompiler">The includeCodeCompiler</h2>
<h6 id="site.hs-51-to-66">site.hs (51 to 66)</h6>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="ot">includeCodeCompiler ::</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">includeCodeCompiler <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  p <span class="ot">&lt;-</span> getResourceFilePath</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  getResourceString <span class="fu">&gt;&gt;=</span> withItemBody (unsafeCompiler <span class="fu">.</span> includeCompile p)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="ot">    includeCompile ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    includeCompile compilingPath source <span class="fu">=</span> </a>
<a class="sourceLine" id="cb8-9" data-line-number="9">      includeCompile' source</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">      <span class="ot">`onException`</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">      putStr (<span class="st">&quot;Exception compiling includes for: &quot;</span> <span class="fu">&lt;&gt;</span> compilingPath)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="ot">    includeCompile' ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    includeCompile' source <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">      <span class="kw">let</span> ls1 <span class="fu">=</span> Txt.lines <span class="fu">$</span> Txt.pack source </a>
<a class="sourceLine" id="cb8-16" data-line-number="16">      <span class="kw">let</span> (sourceNoSetup, repoPath', sha', cmds') <span class="fu">=</span> getConfig ls1 </a></code></pre></div>
<p>A pandoc compiler has the type <code>Compiler (Item String)</code>. Since this compiler needs to read file it has to be able to perform IO. To allow IO the <code>unsafeCompiler</code> function is used.</p>
<p>So this code, gets the current file path, the item body and starts the includeCompile in IO</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1">  p <span class="ot">&lt;-</span> getResourceFilePath</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  getResourceString <span class="fu">&gt;&gt;=</span> withItemBody (unsafeCompiler <span class="fu">.</span> includeCompile p)</a></code></pre></div>
<p><code>onException</code> is used to print the name of the file being compiled if there is an exception.</p>
<p>Once the config (repo, sha and commands) have been read the main compiler logic can be run.</p>
<h6 id="site.hs-70-to-101">site.hs (70 to 101)</h6>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1">      <span class="kw">case</span> (repoPath', sha', cmds') <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">        (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, []) <span class="ot">-&gt;</span> pure <span class="fu">$</span> Txt.unpack <span class="fu">.</span> Txt.unlines <span class="fu">$</span> sourceNoSetup</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">        (<span class="dt">Just</span> _, <span class="dt">Nothing</span>, _) <span class="ot">-&gt;</span> throwString <span class="st">&quot;No sha found&quot;</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">        (<span class="dt">Just</span> _, _, []) <span class="ot">-&gt;</span> throwString <span class="st">&quot;No run commands found&quot;</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">        (<span class="dt">Nothing</span>, _, (_<span class="fu">:</span>_)) <span class="ot">-&gt;</span> throwString <span class="st">&quot;No repo setup found&quot;</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">        (<span class="dt">Nothing</span>, <span class="dt">Just</span> _, []) <span class="ot">-&gt;</span> throwString <span class="st">&quot;No repo setup found&quot;</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">        (<span class="dt">Just</span> repoPath, <span class="dt">Just</span> sha, cmds) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">          root <span class="ot">&lt;-</span> Dir.getCurrentDirectory</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">          <span class="kw">let</span> tempPath <span class="fu">=</span> root <span class="fu">&lt;/&gt;</span> tmpDirectory defaultConfiguration <span class="fu">&lt;/&gt;</span> <span class="st">&quot;codeIncludeGit&quot;</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">          <span class="co">-- Cleanup from previous post</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">          removeDirectoryRecursiveIfExists tempPath</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">          Dir.createDirectoryIfMissing <span class="dt">True</span> tempPath</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">          <span class="co">-- Clone the git repo</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">          runShell' root <span class="fu">$</span> <span class="st">&quot;git clone \&quot;&quot;</span> <span class="fu">&lt;&gt;</span> repoPath <span class="fu">&lt;&gt;</span> <span class="st">&quot;\&quot; \&quot;&quot;</span> <span class="fu">&lt;&gt;</span> Txt.pack tempPath <span class="fu">&lt;&gt;</span> <span class="st">&quot;\&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">          <span class="co">-- Goto the correct sha (if it was specified)</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">          gotoSha sha tempPath</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">          <span class="co">-- Execute the run commands (buid, test etc)</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">          executeRunCommands cmds tempPath</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">          <span class="co">-- Delete all dirs we are not interested in (exclude .git and .stack-work)</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">          removeDirectoryRecursiveIfExists <span class="fu">$</span> tempPath <span class="fu">&lt;/&gt;</span> <span class="st">&quot;.git&quot;</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">          removeDirectoryRecursiveIfExists <span class="fu">$</span> tempPath <span class="fu">&lt;/&gt;</span> <span class="st">&quot;.stack-work&quot;</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">          <span class="co">-- Get all files in the repo </span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">          files <span class="ot">&lt;-</span> getFilesRec tempPath</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">          <span class="co">-- All sections from all files</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26">          sections' <span class="ot">&lt;-</span> Map.fromList <span class="fu">.</span> concat <span class="fu">&lt;$&gt;</span> traverse getSections files</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">          <span class="kw">let</span> sections <span class="fu">=</span> Map.map (\(p, s, e, ls) <span class="ot">-&gt;</span> (drop (length tempPath <span class="fu">+</span> <span class="dv">1</span>) p, s, e, ls)) sections' </a>
<a class="sourceLine" id="cb10-28" data-line-number="28">          <span class="co">-- Replace sections in the file</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29">          replaced' <span class="ot">&lt;-</span> traverse (replaceLineSection sections) sourceNoSetup</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">          <span class="kw">let</span> replaced <span class="fu">=</span> Txt.unlines <span class="fu">.</span> concat <span class="fu">$</span> replaced'</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">          <span class="co">-- Replace sha and repo tokens</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32">          pure <span class="fu">.</span> Txt.unpack <span class="fu">.</span> Txt.replace <span class="st">&quot;f3c9bfa85757304dd9ecf0082625f9bc2de83cb5&quot;</span> sha <span class="fu">$</span> Txt.replace <span class="st">&quot;https://gist.github.com/53e179c4244411493ae1f9deebc3cc3f.git&quot;</span> repoPath replaced</a></code></pre></div>
<h6 id="site.hs-105-to-112">site.hs (105 to 112)</h6>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ot">    executeRunCommands ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    executeRunCommands cmds path <span class="fu">=</span> </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">      traverse_ (runShell' path) cmds</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="ot">    gotoSha ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">    gotoSha sha tmpPath <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">      runShell' tmpPath (<span class="st">&quot;git reset &quot;</span> <span class="fu">&lt;&gt;</span> sha <span class="fu">&lt;&gt;</span> <span class="st">&quot; --hard&quot;</span>) </a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      void <span class="fu">$</span> runShell tmpPath <span class="st">&quot;git clean -dfx&quot;</span></a></code></pre></div>
<p>This code does the following</p>
<ol type="1">
<li>Pre-clone cleanup</li>
<li>Clone</li>
<li>Goto the configured commit</li>
<li>Run the commands</li>
<li>Read all the sections from the files</li>
<li>Import the sections into the markdown</li>
</ol>
<h2 id="details">Details</h2>
<p>Loading the config is done quite simply by filtering the source lines</p>
<h6 id="site.hs-117-to-131">site.hs (117 to 131)</h6>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1">    getConfig ls <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">        cfgRepo <span class="fu">=</span> <span class="st">&quot;[&lt;code setup.repo&gt;]&quot;</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">        cfgSha <span class="fu">=</span> <span class="st">&quot;[&lt;code setup.sha&gt;]&quot;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">        cfgRun <span class="fu">=</span> <span class="st">&quot;[&lt;code setup.run&gt;]&quot;</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">        repo <span class="fu">=</span> Txt.strip <span class="fu">.</span> Txt.drop (Txt.length cfgRepo) <span class="fu">&lt;$&gt;</span> headMay (filter (Txt.isPrefixOf cfgRepo) ls)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">        sha <span class="fu">=</span> Txt.strip <span class="fu">.</span> Txt.drop (Txt.length cfgSha) <span class="fu">&lt;$&gt;</span> headMay (filter (Txt.isPrefixOf cfgSha) ls)</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">        run <span class="fu">=</span> Txt.strip <span class="fu">.</span> Txt.drop (Txt.length cfgRun) <span class="fu">&lt;$&gt;</span> filter (Txt.isPrefixOf cfgRun) ls</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">      (filter (not <span class="fu">.</span> Txt.isPrefixOf <span class="st">&quot;[&lt;code setup.&quot;</span>) ls, repo, sha, run)</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">        </a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    removeDirectoryRecursiveIfExists p <span class="fu">=</span> </a>
<a class="sourceLine" id="cb12-13" data-line-number="13">      Dir.doesDirectoryExist p <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">        <span class="dt">True</span> <span class="ot">-&gt;</span> Dir.removeDirectoryRecursive p</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">        <span class="dt">False</span> <span class="ot">-&gt;</span> pass</a></code></pre></div>
<p>And once the sections have been loaded from the source code the tags can be replaced in the markdown. Each <code>[&lt;code&gt;]</code> tag is replaced by a markdown code block, a title showing the source file and offset.</p>
<h6 id="site.hs-136-to-154">site.hs (136 to 154)</h6>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="ot">    replaceLineSection ::</span> <span class="dt">Map</span> <span class="dt">Text</span> (FilePath, <span class="dt">Int</span>, <span class="dt">Int</span>, [<span class="dt">Text</span>]) <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">Text</span>]</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">    replaceLineSection sections line <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">      <span class="kw">let</span> codeTag <span class="fu">=</span> <span class="st">&quot;[&lt;code&gt;]&quot;</span> </a>
<a class="sourceLine" id="cb13-4" data-line-number="4">      <span class="kw">if</span> not <span class="fu">$</span> Txt.isPrefixOf codeTag line </a>
<a class="sourceLine" id="cb13-5" data-line-number="5">        <span class="kw">then</span> pure [line]</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">          <span class="kw">let</span> secName <span class="fu">=</span> Txt.strip <span class="fu">.</span> Txt.drop (Txt.length codeTag) <span class="fu">$</span> line <span class="kw">in</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">          <span class="kw">case</span> Map.lookup secName sections <span class="kw">of</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwString <span class="fu">$</span> Txt.unpack <span class="fu">$</span> <span class="st">&quot;No section named &quot;</span> <span class="fu">&lt;&gt;</span> secName</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">            <span class="dt">Just</span> (path, start, end, code) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">              <span class="kw">let</span> title <span class="fu">=</span> Txt.pack path <span class="fu">&lt;&gt;</span> <span class="st">&quot; (&quot;</span> <span class="fu">&lt;&gt;</span> show start <span class="fu">&lt;&gt;</span> <span class="st">&quot; to &quot;</span> <span class="fu">&lt;&gt;</span> show end <span class="fu">&lt;&gt;</span> <span class="st">&quot;)&quot;</span> <span class="kw">in</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">              pure [ <span class="st">&quot;###### &quot;</span> <span class="fu">&lt;&gt;</span> title</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">                   , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">                   , <span class="st">&quot;~~~{.haskell}&quot;</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">                   , Txt.unlines code</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">                   , <span class="st">&quot;~~~&quot;</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">                   , <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">                   ]</a></code></pre></div>
<h2 id="getting-sections-from-the-repo">Getting sections from the repo</h2>
<h6 id="site.hs-160-to-193">site.hs (160 to 193)</h6>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">type</span> <span class="dt">LineState</span> <span class="fu">=</span> (<span class="dt">Int</span>, [(<span class="dt">Text</span>, (FilePath, <span class="dt">Int</span>, <span class="dt">Int</span>, [<span class="dt">Text</span>]))]) </a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="ot">getSections ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> [(<span class="dt">Text</span>, (FilePath, <span class="dt">Int</span>, <span class="dt">Int</span>, [<span class="dt">Text</span>]))]</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">getSections f <span class="fu">=</span> </a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  <span class="kw">case</span> FP.takeExtension f <span class="kw">of</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    <span class="st">&quot;.hs&quot;</span> <span class="ot">-&gt;</span> getHaskellSections</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    _ <span class="ot">-&gt;</span> pure []</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">    getHaskellSections <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">      ls <span class="ot">&lt;-</span> Txt.lines <span class="fu">&lt;$&gt;</span> Txt.readFile f</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">      (_, r) <span class="ot">&lt;-</span> foldlM (parseLine ls) (<span class="dv">1</span>, []) ls</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">      pure r</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="ot">        parseLine ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> <span class="dt">LineState</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">LineState</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17">        parseLine ls (lineNum, hist) l <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18">          <span class="kw">if</span> not <span class="fu">.</span> Txt.isPrefixOf <span class="st">&quot;{-! SECTION&lt; &quot;</span> <span class="fu">.</span> Txt.strip <span class="fu">$</span> l</a>
<a class="sourceLine" id="cb14-19" data-line-number="19">          <span class="kw">then</span> pure (lineNum <span class="fu">+</span> <span class="dv">1</span>, hist)</a>
<a class="sourceLine" id="cb14-20" data-line-number="20">          <span class="kw">else</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21">            <span class="kw">let</span> secName <span class="fu">=</span> Txt.strip <span class="fu">.</span> fst <span class="fu">.</span> Txt.breakOn <span class="st">&quot; &quot;</span> <span class="fu">.</span> Txt.strip <span class="fu">.</span> Txt.drop (Txt.length <span class="st">&quot;{-! SECTION&lt; &quot;</span>) <span class="fu">$</span> l </a>
<a class="sourceLine" id="cb14-22" data-line-number="22">            end <span class="ot">&lt;-</span> scanForEnd ls secName lineNum</a>
<a class="sourceLine" id="cb14-23" data-line-number="23">            pure (lineNum <span class="fu">+</span> <span class="dv">1</span>, (secName, (f, lineNum <span class="fu">+</span> <span class="dv">1</span>, lineNum <span class="fu">+</span> length end, end)) <span class="fu">:</span> hist)</a>
<a class="sourceLine" id="cb14-24" data-line-number="24"></a>
<a class="sourceLine" id="cb14-25" data-line-number="25">        scanForEnd ls secName fromLine <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-26" data-line-number="26">          <span class="kw">let</span> fromOffset <span class="fu">=</span> drop fromLine ls <span class="kw">in</span></a>
<a class="sourceLine" id="cb14-27" data-line-number="27">          <span class="kw">case</span> Lst.span (not <span class="fu">.</span> Txt.isPrefixOf (<span class="st">&quot;{-! SECTION&gt; &quot;</span> <span class="fu">&lt;&gt;</span> secName) <span class="fu">.</span> Txt.strip) fromOffset <span class="kw">of</span></a>
<a class="sourceLine" id="cb14-28" data-line-number="28">            (_, []) <span class="ot">-&gt;</span> throwString <span class="fu">$</span> <span class="st">&quot;No section end found for: &quot;</span> <span class="fu">&lt;&gt;</span> Txt.unpack secName</a>
<a class="sourceLine" id="cb14-29" data-line-number="29">            (r, _) <span class="ot">-&gt;</span> pure <span class="fu">$</span> cleanLine <span class="fu">&lt;$&gt;</span> r</a>
<a class="sourceLine" id="cb14-30" data-line-number="30"></a>
<a class="sourceLine" id="cb14-31" data-line-number="31">        cleanLine l <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-32" data-line-number="32">          <span class="kw">if</span> Txt.isPrefixOf <span class="st">&quot;{-! SECTION&quot;</span> <span class="fu">.</span> Txt.strip <span class="fu">$</span> l</a>
<a class="sourceLine" id="cb14-33" data-line-number="33">          <span class="kw">then</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb14-34" data-line-number="34">          <span class="kw">else</span> l</a></code></pre></div>
<p>Different types of files will need different tag styles. In the code above I’m only handling haskell code. This pattern can probably be used for most other source code types as well.</p>
<p><code>parseLine</code> works by going line by line looking for a start token, and for each one that it finds it scans to find the end token. This is a little inefficient but it allows for nested and/or overlapping tags.</p>
<h1 id="using-the-compiler">Using the compiler</h1>
<p>Once you add this to your hakyll you can be sure that you are only using working code blocks. While there is a bit of code in this compiler most of it is for dealing with the file IO and parsing. I think it also shows how easily hakyll can be customised to do useful things.</p>
<p>This code works with hakyll 4.10.0.0. See the cabal file in the gist for other dependencies</p>
<h1 id="links">Links</h1>
<ul>
<li><a href="https://gist.github.com/andrevdm/53e179c4244411493ae1f9deebc3cc3f">Code on github</a> f3c9bfa85757304dd9ecf0082625f9bc2de83cb5</li>
<li><a href="https://jaspervdj.be/hakyll/tutorials.html">Hakyll tutorial</a></li>
<li><a href="https://medium.com/@phlummox/the-simplest-custom-hakyll-compiler-6ee7b189a6c6">The simplest custom Hakyll compiler</a></li>
</ul>


        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          
          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
