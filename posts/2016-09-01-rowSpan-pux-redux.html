<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">Row span with PureScript pux and JavaScript redux</a></h1>

            <div class="info">
    Posted on September  1, 2016
    
</div>

<h1 id="row-spans">Row spans</h1>
<p>I’ve always found creating tables that need rowspans a bit awkward. Having to skip TDs in the rows means that the logic to create each row can get a bit ugly. Typically I just want to map over an array of and get an array of TDs. Fortunately its quite easy to create a function to help make this easier. To keep it interesting I’m going to implement it in PureScript and JavaScript and compare a Haskell version of the function too.</p>
<h1 id="the-data">The data</h1>
<p>As an example imagine I have a set of data to display that shows the days an event occurred per month per day. Starting at the end, this is what I want the result to look like. You can see that the each year spans over the months + days and each month spans over the days.</p>
<p><img src="../images/rowSpan_final.png" /></p>
<h2 id="purescript">PureScript</h2>
<p>Here is how the data could be represented in PureScript using records</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1">  <span class="kw">let</span> dates <span class="fu">=</span> [{year<span class="fu">:</span><span class="dv">2016</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">              ,months<span class="fu">:</span>[{month<span class="fu">:</span><span class="dv">11</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">                       ,days<span class="fu">:</span>[{day<span class="fu">:</span><span class="dv">30</span>}</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">                             ,{day<span class="fu">:</span><span class="dv">10</span>}</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">                             ]</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">                       }</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">                      ,{month<span class="fu">:</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">                       ,days<span class="fu">:</span>[{day<span class="fu">:</span><span class="dv">15</span>}</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">                             ,{day<span class="fu">:</span><span class="dv">3</span>}</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">                             ,{day<span class="fu">:</span><span class="dv">1</span>}</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">                             ]</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">                       }</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">                      ]</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">              }</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">             ,{year<span class="fu">:</span><span class="dv">2015</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">              ,months<span class="fu">:</span>[{month<span class="fu">:</span><span class="dv">5</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">                       ,days<span class="fu">:</span>[{day<span class="fu">:</span><span class="dv">20</span>}</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">                             ,{day<span class="fu">:</span><span class="dv">17</span>}</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">                             ]</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">                       }</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">                      ]</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">              }</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">             ]</a></code></pre></div>
<p>Now we need something to map this data to. The simplest thing to do is to map it to a structure where each row contains the same number of columns and have a secondary function manage the shenanigans of omitting TDs that are spanned over.</p>
<p>Here is a definition for the row and column types</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Col</span> c <span class="fu">=</span> {span<span class="ot"> ::</span> <span class="dt">Int</span> <span class="fu">|</span> c}</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">type</span> <span class="dt">Row</span> r c <span class="fu">=</span> {<span class="ot">cols ::</span> <span class="dt">Array</span> (<span class="dt">Col</span> c) <span class="fu">|</span> r}</a></code></pre></div>
<p>Each row has columns and each column has a span. PureScript has extensible record types that support row polymorphism. What that means here is that we can define a function that accepts these types but the data actually passed to the function can be a superset of the required values. React for example needs a unique element id and obviously each column needs a value to be displayed. Rather than forcing this on the user of the rowSpan algorithm however we just get PureScript to check for the actual fields we need and let the caller add whatever extra data they need.</p>
<p>Here is a function to take the data above and creates an array of <strong>Row</strong>s.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1">  <span class="kw">let</span> rowData <span class="fu">=</span> concat <span class="fu">$</span> concat <span class="fu">$</span> map</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">                (\y <span class="ot">-&gt;</span> map</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                       (\m <span class="ot">-&gt;</span> map</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">                              (\d <span class="ot">-&gt;</span> {rid<span class="fu">:</span>y<span class="fu">.</span>year <span class="fu">*</span> <span class="dv">100</span> <span class="fu">+</span> m<span class="fu">.</span>month</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                                     ,cols<span class="fu">:</span>[{val<span class="fu">:</span>show y<span class="fu">.</span>year,  span<span class="fu">:</span>length <span class="fu">$</span> concat <span class="fu">$</span> map (\a <span class="ot">-&gt;</span> a<span class="fu">.</span>days) y<span class="fu">.</span>months}</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                                           ,{val<span class="fu">:</span>show m<span class="fu">.</span>month, span<span class="fu">:</span>length m<span class="fu">.</span>days}</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">                                           ,{val<span class="fu">:</span>show d<span class="fu">.</span>day,   span<span class="fu">:</span><span class="dv">1</span>}</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                                           ]</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">                                     })</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                              m<span class="fu">.</span>days)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">                       y<span class="fu">.</span>months)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">                dates</a></code></pre></div>
<p>The result of this is an array of Rows. I.e. the data has been flattened and looks something like this</p>
<p><img src="../images/rowSpan_flat.png" /></p>
<p>Each <strong>Row</strong> has a rid (row id) field. Each column has a val (value) and a span field. The <strong>Col</strong>’s val contains the text to display and the span is the number of columns to span. This is simple to calculate. For months its the number of days in that month, for a year its the total number of days in all months in the year.</p>
<h1 id="the-rowspan-algorithm">The rowSpan algorithm</h1>
<p>Given a grid of data (<strong>Array</strong> of <strong>Row</strong>) we need a function that can remove the cols that are to be spanned over. This result can then be mapped over to generate the required TRs and TDs.</p>
<p>Effectively the function must do this</p>
<p><img src="../images/rowSpan_remove.png" /></p>
<p>Here is one way to achieve this</p>
<ol type="1">
<li>For each column have a <em>collapse</em> integer showing how many more times the col in its position should be skipped</li>
<li>Start with a 0 for each column, i.e. the first row always has all the columns</li>
<li>For each col in a row
<ol type="1">
<li>If <em>collapse</em> is zero then
<ol type="1">
<li>Include the column.</li>
<li>Use the <em>span</em> from the <strong>Col</strong> as the next <em>collapse</em> value</li>
</ol></li>
<li>Else if <em>collapse</em> is not zero then
<ol type="1">
<li>Ignore the column</li>
<li>Use the <em>collapse</em> value minus one as the next <em>collapse</em> value</li>
</ol></li>
</ol></li>
</ol>
<p>In the image below you can see the grid with the initial collapse value per row. As above notice that a column is removed unless the <em>collapse</em> value is zero.</p>
<p><img src="../images/rowSpan_collapse.png" /></p>
<p>And here is the PureScript code to do this</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="ot">collapseTableArray ::</span> forall r c<span class="fu">.</span> <span class="dt">Array</span> (<span class="dt">Row</span> r c) <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Row</span> r c)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">collapseTableArray rows <span class="fu">=</span> </a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="co">-- | To create the initial collapse array, we need to know the number of cols in a row</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="co">-- | Get the number of cols in each row and then  get the minimum value</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="co">-- | PureScript being safe ensures that the empty list case is handled</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="kw">case</span> minimum <span class="fu">$</span> (\r <span class="ot">-&gt;</span> length r<span class="fu">.</span>cols) <span class="fu">&lt;$&gt;</span> rows <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="dt">Just</span> m <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">      <span class="co">-- | Initial collapse array of zeros</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">      <span class="kw">let</span> collapse <span class="fu">=</span> replicate m <span class="dv">0</span> <span class="kw">in</span> </a>
<a class="sourceLine" id="cb4-10" data-line-number="10">      <span class="co">-- | fold rows with collapseRow</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">      <span class="kw">let</span> fixed <span class="fu">=</span> foldl collapseRow {collapse<span class="fu">:</span> collapse, st<span class="fu">:</span> []} rows <span class="kw">in</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">      fixed<span class="fu">.</span>st</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    _ <span class="ot">-&gt;</span> []</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">    <span class="co">-- | The fold function</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="ot">    collapseRow ::</span> forall rr cc ss<span class="fu">.</span> (<span class="dt">CollapseState</span> rr cc ss) <span class="ot">-&gt;</span> <span class="dt">Row</span> rr cc <span class="ot">-&gt;</span> (<span class="dt">CollapseState</span> rr cc ss)</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">    collapseRow state row <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">      <span class="co">-- | Zip the previous collapse array and the current cols array</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">      <span class="co">-- | This results in an array of [collapse, col]</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">      <span class="kw">let</span> skipCols <span class="fu">=</span> zip state<span class="fu">.</span>collapse row<span class="fu">.</span>cols <span class="kw">in</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">      <span class="co">-- | Get all cols where the collapse value is less than 1</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">      <span class="co">-- | First the list is filtered by checking the collapse value (fst in array)</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24">      <span class="co">-- | Then snd is called (fmapped over) each itemm to get only the column</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25">      <span class="co">-- | Note that this results in the selected columns being unaltered and all additional information (fields)</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26">      <span class="co">-- |  in the columns being retained</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27">      <span class="kw">let</span> nextCols <span class="fu">=</span> snd <span class="fu">&lt;$&gt;</span> filter (\t <span class="ot">-&gt;</span> fst t <span class="fu">&lt;=</span> <span class="dv">0</span>) skipCols <span class="kw">in</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">      <span class="co">-- | If current collapse is zero then next skip is the span value - 1 else its collapse - 1</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29">      <span class="kw">let</span> nextSkip <span class="fu">=</span> map (\t <span class="ot">-&gt;</span> <span class="kw">if</span> fst t <span class="fu">==</span> <span class="dv">0</span> <span class="kw">then</span> (snd t)<span class="fu">.</span>span <span class="fu">-</span> <span class="dv">1</span> <span class="kw">else</span> (fst t) <span class="fu">-</span> <span class="dv">1</span>) skipCols <span class="kw">in</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30">      <span class="co">-- | Construct the row, change only the cols</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31">      <span class="co">-- | Again, note that the other fields in the row are returned unaltered</span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32">      <span class="kw">let</span> resRow <span class="fu">=</span> row { cols <span class="fu">=</span> nextCols } <span class="kw">in</span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33">      <span class="co">-- | Next state</span></a>
<a class="sourceLine" id="cb4-34" data-line-number="34">      state {collapse <span class="fu">=</span> nextSkip, st <span class="fu">=</span> snoc state<span class="fu">.</span>st resRow }</a></code></pre></div>
<p>Finally here is the Pux code to generate the HTML from the result of <em>collapseTableArray</em></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ot">getTable ::</span> forall a<span class="fu">.</span> <span class="dt">Html</span> a</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">getTable <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="kw">let</span> rowData <span class="fu">=</span> <span class="co">-- See above</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="kw">let</span> c <span class="fu">=</span> collapseTableArray rowData <span class="kw">in</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="kw">let</span> tableRows <span class="fu">=</span> map buildRow c <span class="kw">in</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  div</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    []</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    [table</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">       []</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">       [thead</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">          []</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">          [tr</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">             []</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">             [th [] [text <span class="st">&quot;year&quot;</span>]</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">             ,th [] [text <span class="st">&quot;month&quot;</span>]</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">             ,th [] [text <span class="st">&quot;day&quot;</span>]</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">             ]</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">          ]</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">       ,tbody</a>
<a class="sourceLine" id="cb5-21" data-line-number="21">          []</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">          (buildRow <span class="fu">&lt;$&gt;</span> c)</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">       ]</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">    ]</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26">    buildRow r <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27">      tr</a>
<a class="sourceLine" id="cb5-28" data-line-number="28">      []</a>
<a class="sourceLine" id="cb5-29" data-line-number="29">      (buildCol <span class="fu">&lt;$&gt;</span> r<span class="fu">.</span>cols)</a>
<a class="sourceLine" id="cb5-30" data-line-number="30"></a>
<a class="sourceLine" id="cb5-31" data-line-number="31">    buildCol c <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-32" data-line-number="32">      td</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">        [attr <span class="st">&quot;rowSpan&quot;</span> c<span class="fu">.</span>span]</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">        [text <span class="fu">$</span> c<span class="fu">.</span>val]</a></code></pre></div>
<h1 id="javascript-and-redux">JavaScript and Redux</h1>
<p>Here is what that would look like in JavaScript. The example uses <a href="https://github.com/reactjs/redux">Redux</a> (react-redux) for the rendering and <a href="http://ramdajs.com/">Ramda</a> for the functional programming features. The code is compiled with babel with ES2015 syntax and the object spread operator enabled.</p>
<p>The data looks very similar to the PureScript data.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" data-line-number="1">  [<span class="op">{</span><span class="dt">year</span><span class="op">:</span><span class="dv">2016</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    <span class="dt">months</span><span class="op">:</span>[<span class="op">{</span><span class="dt">month</span><span class="op">:</span><span class="dv">11</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">             <span class="dt">days</span><span class="op">:</span>[<span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">30</span><span class="op">},</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">                   <span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">10</span><span class="op">}</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">                  ]</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">            <span class="op">},</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">            <span class="op">{</span><span class="dt">month</span><span class="op">:</span><span class="dv">2</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">             <span class="dt">days</span><span class="op">:</span>[<span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">15</span><span class="op">},</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">                   <span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">3</span><span class="op">},</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">                   <span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">1</span><span class="op">}</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">                  ]</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">            <span class="op">}</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">           ]</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">   <span class="op">},</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">   <span class="op">{</span><span class="dt">year</span><span class="op">:</span><span class="dv">2015</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="dt">months</span><span class="op">:</span>[<span class="op">{</span><span class="dt">month</span><span class="op">:</span><span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17">             <span class="dt">days</span><span class="op">:</span>[<span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">20</span><span class="op">},</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18">                   <span class="op">{</span><span class="dt">day</span><span class="op">:</span><span class="dv">17</span><span class="op">}</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19">                  ]</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">            <span class="op">}</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21">           ]</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">   <span class="op">}</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23">  ]<span class="op">;</span></a></code></pre></div>
<p>As with the PureScript example the first step is to create a flattened grid of the data and then call collapseTableArray on it.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" data-line-number="1">  <span class="kw">const</span> daysInYear <span class="op">=</span> y <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">flatten</span>( <span class="va">R</span>.<span class="at">map</span>( m <span class="op">=&gt;</span> <span class="va">m</span>.<span class="at">days</span><span class="op">,</span> <span class="va">y</span>.<span class="at">months</span> ) )<span class="op">;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="kw">const</span> rows <span class="op">=</span> <span class="va">R</span>.<span class="at">flatten</span>( <span class="va">R</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    y <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">      m <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">        d <span class="op">=&gt;</span> (<span class="op">{</span><span class="dt">rowId</span><span class="op">:</span> <span class="va">y</span>.<span class="at">year</span> <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> <span class="va">m</span>.<span class="at">month</span> <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> <span class="va">d</span>.<span class="at">day</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">               <span class="dt">cols</span><span class="op">:</span>[<span class="op">{</span><span class="dt">val</span><span class="op">:</span> <span class="va">y</span>.<span class="at">year</span><span class="op">,</span>  <span class="dt">span</span><span class="op">:</span> <span class="at">daysInYear</span>(y).<span class="at">length</span><span class="op">}</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">                    <span class="op">,{</span><span class="dt">val</span><span class="op">:</span> <span class="va">m</span>.<span class="at">month</span><span class="op">,</span> <span class="dt">span</span><span class="op">:</span> <span class="va">m</span>.<span class="va">days</span>.<span class="at">length</span><span class="op">}</span> </a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                    <span class="op">,{</span><span class="dt">val</span><span class="op">:</span> <span class="va">d</span>.<span class="at">day</span><span class="op">,</span>   <span class="dt">span</span><span class="op">:</span> <span class="dv">1</span><span class="op">}</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                    ]</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">              <span class="op">}</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="va">m</span>.<span class="at">days</span> )<span class="op">,</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">      <span class="va">y</span>.<span class="at">months</span> )<span class="op">,</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    data )</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">  <span class="kw">var</span> collapsed <span class="op">=</span> <span class="at">collapseTableArray</span>( rows )<span class="op">;</span></a></code></pre></div>
<p>The JavaScript version of the collapseTableArray function works in exactly the same way. Using Rambda and the ES2015 syntax (lambdas, destructuring etc) allows the JavaScript code to be nice and functional.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" data-line-number="1">  <span class="kw">const</span> collapseTableArray <span class="op">=</span> (tableArray) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    <span class="cf">if</span>( <span class="va">R</span>.<span class="at">isEmpty</span>(tableArray) )<span class="op">{</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">      <span class="cf">return</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    <span class="co">//First collapse array is just a 0 for each col on first row</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">    <span class="kw">var</span> collapse <span class="op">=</span> <span class="va">R</span>.<span class="at">map</span>( a <span class="op">=&gt;</span> <span class="dv">0</span><span class="op">,</span> tableArray[<span class="dv">0</span>].<span class="at">cols</span> )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb8-9" data-line-number="9">    <span class="kw">var</span> fixed <span class="op">=</span> <span class="va">R</span>.<span class="at">reduce</span>(</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">      ([skip<span class="op">,</span> acc]<span class="op">,</span>row) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">        <span class="co">//combine the skip list and cols</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">        <span class="kw">const</span> skipCols <span class="op">=</span> <span class="va">R</span>.<span class="at">zip</span>( skip<span class="op">,</span> <span class="va">row</span>.<span class="at">cols</span> )</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">        <span class="co">//Get the col that should not be skipped (2nd item from each of the filtered pair)</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">        <span class="kw">const</span> nextCols <span class="op">=</span> <span class="va">R</span>.<span class="at">map</span>( p <span class="op">=&gt;</span> p[<span class="dv">1</span>]<span class="op">,</span> <span class="va">R</span>.<span class="at">filter</span>( f <span class="op">=&gt;</span> f[<span class="dv">0</span>] <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">,</span> skipCols ) )</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">        <span class="co">//Calculate next skip. Look at prev skip, use the rowSpan from tableArray once the previous span has been used up</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">        <span class="kw">const</span> nextSkip <span class="op">=</span> <span class="va">R</span>.<span class="at">map</span>( p <span class="op">=&gt;</span> p[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> p[<span class="dv">1</span>].<span class="at">span</span> <span class="op">-</span> <span class="dv">1</span> : p[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> skipCols )</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb8-18" data-line-number="18">        <span class="kw">const</span> res <span class="op">=</span> <span class="va">R</span>.<span class="at">concat</span>( acc<span class="op">,</span> [<span class="op">{</span>...<span class="at">row</span><span class="op">,</span> <span class="dt">cols</span><span class="op">:</span>nextCols<span class="op">}</span>] )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">        <span class="cf">return</span> [nextSkip<span class="op">,</span> res]<span class="op">;</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">      <span class="op">},</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21">      [collapse<span class="op">,</span>[]]<span class="op">,</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22">      tableArray )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb8-24" data-line-number="24">    <span class="cf">return</span> fixed[<span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25">  <span class="op">}</span></a></code></pre></div>
<p>Finally the data is rendered with react</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb9-1" data-line-number="1">  return (</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">    <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">      <span class="kw">&lt;table&gt;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">        <span class="kw">&lt;thead&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">          <span class="kw">&lt;tr&gt;</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">            <span class="kw">&lt;th&gt;</span>Year<span class="kw">&lt;/th&gt;</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">            <span class="kw">&lt;th&gt;</span>Month<span class="kw">&lt;/th&gt;</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">            <span class="kw">&lt;th&gt;</span>Day<span class="kw">&lt;/th&gt;</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">          <span class="kw">&lt;/tr&gt;</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">        <span class="kw">&lt;/thead&gt;</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">        <span class="kw">&lt;tbody&gt;</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">          {R.map( r =&gt; (<span class="kw">&lt;tr</span><span class="ot"> key=</span><span class="st">{r.rowId}</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">                         {R.map( c =&gt; (<span class="kw">&lt;td</span><span class="ot"> rowSpan=</span><span class="st">{c.span}</span><span class="ot"> key=</span><span class="st">{r.rowId</span> <span class="er">+</span> <span class="er">&quot;.&quot;</span> <span class="er">+</span><span class="ot"> c.val</span><span class="er">}</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">                                         {c.val}</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">                                       <span class="kw">&lt;/td&gt;</span>),</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">                                 r.cols )}</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">                        <span class="kw">&lt;/tr&gt;</span>),</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">                  collapsed )}</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">        <span class="kw">&lt;/tbody&gt;</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20">      <span class="kw">&lt;/table&gt;</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21">    <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22">  );</a></code></pre></div>
<h1 id="haskell">Haskell</h1>
<p>While I’ve not implemented the HTML rendering with GHCJS I think its interesting to compare the PureScript and Haskell version of the collapseTableArray functions</p>
<p>Starting with the Haskell types</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Col</span> c <span class="fu">=</span> <span class="dt">Col</span> {span<span class="ot"> ::</span> <span class="dt">Int</span>,<span class="ot"> cval ::</span> c} <span class="kw">deriving</span> <span class="dt">Show</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">data</span> <span class="dt">Row</span> r c <span class="fu">=</span> <span class="dt">Row</span> {<span class="ot">cols ::</span> [<span class="dt">Col</span> c],<span class="ot"> rval ::</span> r} <span class="kw">deriving</span> <span class="dt">Show</span></a></code></pre></div>
<p>Haskell does not have row polymorphism (e.g. extensible records) so to allow the <strong>Row</strong> and <strong>Col</strong> types to have user defined values I’ve used a record with type params</p>
<p>In this example I’m using <strong>Rid</strong> and <strong>Cval</strong> as defined below</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Rid</span> <span class="fu">=</span> <span class="dt">Rid</span> <span class="dt">Int</span> <span class="kw">deriving</span> <span class="dt">Show</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">data</span> <span class="dt">Cval</span> <span class="fu">=</span> <span class="dt">Cval</span> <span class="dt">Text</span> <span class="kw">deriving</span> <span class="dt">Show</span></a></code></pre></div>
<p>The Haskell collapseTableArray is very similar to the PureScript version</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1">  <span class="co">-- | same as minimum but check for an empty list</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="ot">  minimumSafe ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  minimumSafe xs <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    <span class="kw">case</span> xs <span class="kw">of</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">      [] <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">      _ <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="fu">$</span> minimum xs</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="ot">  collapseTableArray ::</span> [<span class="dt">Row</span> r c] <span class="ot">-&gt;</span> [<span class="dt">Row</span> r c]</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">  collapseTableArray rows <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">    <span class="co">-- | To create the initial collapse array, we need to know the number of cols in a row</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">    <span class="co">-- | Get the number of cols in each row and then  get the minimum value</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    <span class="co">-- | Use minimumSafe to guard against an empty list</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    <span class="kw">case</span> minimumSafe <span class="fu">$</span> (\r <span class="ot">-&gt;</span> length <span class="fu">$</span> cols r) <span class="fu">&lt;$&gt;</span> rows <span class="kw">of</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">      <span class="dt">Just</span> i <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15">        <span class="co">-- | Initial collapse array of zeros</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16">        <span class="kw">let</span> collapse <span class="fu">=</span> replicate i <span class="dv">0</span> <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">        <span class="co">-- | fold rows with collapseRow</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18">        <span class="kw">let</span> (c,res) <span class="fu">=</span> foldl collapseRow (collapse, []) rows <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19">        res</a>
<a class="sourceLine" id="cb12-20" data-line-number="20">      _ <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21">        []</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb12-23" data-line-number="23">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24">      <span class="co">-- | The fold function</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="ot">      collapseRow ::</span> ([<span class="dt">Int</span>], [<span class="dt">Row</span> r c]) <span class="ot">-&gt;</span> <span class="dt">Row</span> r c <span class="ot">-&gt;</span> ([<span class="dt">Int</span>], [<span class="dt">Row</span> r c])</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">      collapseRow (collapse, res) row <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27">        <span class="co">-- | Zip the previous collapse array and the current cols array</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28">        <span class="co">-- | This results in a tuple of (collapse, col)</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29">        <span class="kw">let</span> skipCols <span class="fu">=</span> zip collapse <span class="fu">$</span> cols row <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30">        <span class="co">-- | Get all cols where the collapse value is less than 1</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31">        <span class="co">-- | First the list is filtered by checking the collapse value (the first value in the tuple)</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32">        <span class="co">-- | Then snd is called (fmapped over) each tuple to get only the column</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33">        <span class="kw">let</span> nextCols <span class="fu">=</span> snd <span class="fu">&lt;$&gt;</span> filter (\(c,_) <span class="ot">-&gt;</span> c <span class="fu">&lt;=</span> <span class="dv">0</span>) skipCols <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34">        <span class="co">-- | If current collapse is zero then next skip is the span value - 1 else its collapse - 1</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35">        <span class="kw">let</span> nextSkip <span class="fu">=</span> map (\(c,r) <span class="ot">-&gt;</span> <span class="kw">if</span> c <span class="fu">==</span> <span class="dv">0</span> <span class="kw">then</span> (span r) <span class="fu">-</span> <span class="dv">1</span> <span class="kw">else</span> c <span class="fu">-</span> <span class="dv">1</span>) skipCols <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36">        <span class="co">-- | Construct the row, change only the cols</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37">        <span class="kw">let</span> resRow <span class="fu">=</span> row { cols <span class="fu">=</span> nextCols } <span class="kw">in</span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38">        (nextSkip, res <span class="fu">&lt;&gt;</span> [resRow])</a></code></pre></div>
<p>A few differences to note from PureScript</p>
<ol type="1">
<li><code>deriving show</code> makes printing values easy. The sample project prints the result to the console</li>
<li><em>minimum</em> is not safe by default, so I’m using a custom <em>safeMinimum</em> to check for empty lists</li>
<li>Support for tuples and tuple destructuring</li>
<li>record functions to get values rather than field access</li>
</ol>
<p>Overall though the differences are small.</p>
<h1 id="building-the-sample-projects">Building the sample projects</h1>
<p>All the code for the <a href="https://github.com/andrevdm/rowSpanPureScriptJs">examples is on github</a></p>
<ul>
<li>PureScript
<ol type="1">
<li>In the ps directory run <code>setupPs.sh</code></li>
<li>Run <code>pulp build</code> to build</li>
<li>Run <code>npm sttart</code> to build and run the site.</li>
<li>Browse to http://localhost:3000/</li>
</ol></li>
<li>JavaScript
<ol type="1">
<li>In the js directory run <code>setupBable.sh</code></li>
<li>Run <code>runBabelAndWatch.sh</code> to build the bable js</li>
<li>Start a web server in the js/demo directory (e.g. node’s http-server)</li>
</ol></li>
<li>Haskell
<ol type="1">
<li>Ensure you have stack installed</li>
<li>In the hs directory run <code>stack build</code></li>
<li>Run <code>buildAndRun.sh</code></li>
</ol></li>
</ul>
<h1 id="links">Links</h1>
<ol type="1">
<li><a href="https://github.com/andrevdm/rowSpanPureScriptJs">Source code for the examples</a>.</li>
<li><a href="https://github.com/alexmingoia/pux-starter-app">Purescript pux starter app</a>.</li>
<li><a href="http://ramdajs.com/">Ramda</a>.</li>
<li><a href="https://github.com/reactjs/redux">Redux</a>.</li>
<li><a href="https://www.haskellstack.org/">Stack</a>.</li>
<li><a href="https://github.com/sdiehl/protolude">Protolude</a></li>
<li><a href="https://leanpub.com/purescript">PureScript By Example</a>. The PureScript book</li>
<li><a href="http://www.alexmingoia.com/purescript-pux/index.html">Pux Tutorial</a></li>
<li><a href="http://haskellbook.com/">Haskell Programming from first principles</a>.</li>
</ol>


        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          
          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
