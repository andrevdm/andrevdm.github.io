<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../../">Home</a>
                <a href="../../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">2018-04-02-haskell-rogue-like_12</a></h1>

            <div class="info">
    Posted on April  2, 2018
    
</div>

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../../">Home</a>
                <a href="../../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">Haskell roguelike - Energy & Time Systems</a></h1>

            <div class="info">
    Posted on April  2, 2018
    
</div>

<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_11.html">prev</a> <a href="2018-04-02-haskell-rogue-like_13.html">next</a></p>
<h1 id="time-systems">Time systems</h1>
<p>The game is now at the point that we need to start considering how the non-player actors are going to move and interact with the world. Most roguelikes are turn based, when it is the player’s turn they can take as long as they want to make a move. Once the player moves each of the other actors get a turn.</p>
<p>Its unlikely that each action an actor can take should take up exactly one turn. For example consider</p>
<ul>
<li>an actor class that moves slower than other actors (e.g. a snail)</li>
<li>an actor class that moves faster</li>
<li>making it slower to walk over some surfaces than other (e.g. ice vs bricks)</li>
<li>actions that should not count as a full turn e.g. recharging, preparing spells, eating etc</li>
</ul>
<p>There are many potential ways to design this, see e.g.</p>
<ul>
<li><a href="http://www.roguebasin.com/index.php?title=Articles#Time_management">Time management @ roguebasin</a></li>
<li><a href="https://www.reddit.com/r/roguelikedev/comments/4pk2k6/faq_friday_41_time_systems/">/r/roguelikedev FAQ 41</a></li>
</ul>
<h1 id="energy-system">Energy system</h1>
<p>I’ve chosen to implement an ‘energy system’ to do the time management. In an energy system</p>
<ul>
<li>Each actor has a quantity of available energy</li>
<li>Actors need a certain amount of energy before they can perform any action</li>
<li>Each actor is given a fixed amount of energy each turn</li>
<li>Actors can perform multiple actions in one move if they have the energy for it</li>
<li>Actors can store energy for future moves</li>
<li>There is a per-actor or per-class limit on how much energy can be stored</li>
<li>The same action can cost a different amount of energy for different actors. E.g. a slow moving actor has a higher move energy cost than a fast actor.</li>
</ul>
<p>For example if we wanted a fast and a slow actor we could set it up as follows</p>
<table>
<thead>
<tr class="header">
<th>Actor</th>
<th>Max energy</th>
<th>Move energy cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>slow</td>
<td>150</td>
<td>150</td>
</tr>
<tr class="even">
<td>fast</td>
<td>100</td>
<td>100</td>
</tr>
</tbody>
</table>
<p>Lets see how that would work for several turns</p>
<ul>
<li>energy added per tick = 100</li>
<li>min move energy = 100</li>
</ul>
<table>
<thead>
<tr class="header">
<th>Tick</th>
<th>Actor</th>
<th>Energy</th>
<th>Action</th>
<th>Remaining after turn</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>slow</td>
<td>0</td>
<td>not enough energy to move</td>
<td>0</td>
</tr>
<tr class="even">
<td>1</td>
<td>fast</td>
<td>0</td>
<td>not enough energy to move</td>
<td>0</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>2</td>
<td>slow</td>
<td>100</td>
<td>not enough energy to move (needs 150)</td>
<td>100</td>
</tr>
<tr class="odd">
<td>2</td>
<td>fast</td>
<td>100</td>
<td>move using 100 energy points</td>
<td>0</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>slow</td>
<td>150</td>
<td>move using 100 energy points (note max stored is 150)</td>
<td>0</td>
</tr>
<tr class="even">
<td>3</td>
<td>fast</td>
<td>100</td>
<td>move using 100 energy points</td>
<td>0</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>4</td>
<td>slow</td>
<td>0</td>
<td>not enough energy to move (needs 150)</td>
<td>100</td>
</tr>
<tr class="odd">
<td>4</td>
<td>fast</td>
<td>100</td>
<td>move using 100 energy points</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>As you can see the fast actor gets to move each turn, the slow actor ends up skipping turns until it has stored enough energy.</p>
<p>The time system you choose will effect the feel of your game, but I think an energy based system like this is both simple enough to implement and also flexible enough to grow with your game’s requirements.</p>
<h1 id="bounded-values">Bounded values</h1>
<p>Before discussing the implementation of an energy system lets implement a small utility type for dealing with bounded values. E.g. we need a type that manages storing the actor’s energy and ensures that the upper and lower bounds are honoured.</p>
<h6 id="energysrcboundedint.hs-4-to-38">12_energy/src/BoundedInt.hs (4 to 38)</h6>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">module</span> <span class="dt">BoundedInt</span> ( <span class="dt">BInt</span></a>
<a class="sourceLine" id="cb1-2" title="2">                  , new</a>
<a class="sourceLine" id="cb1-3" title="3">                  , update</a>
<a class="sourceLine" id="cb1-4" title="4">                  , set</a>
<a class="sourceLine" id="cb1-5" title="5">                  , get</a>
<a class="sourceLine" id="cb1-6" title="6">                  , getMax</a>
<a class="sourceLine" id="cb1-7" title="7">                  ) <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">import</span> <span class="dt">Protolude</span> <span class="kw">hiding</span> (maxBound, get)</a>
<a class="sourceLine" id="cb1-10" title="10"></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">newtype</span> <span class="dt">BInt</span> <span class="fu">=</span> <span class="dt">BInt</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="ot">new ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">BInt</span></a>
<a class="sourceLine" id="cb1-14" title="14">new <span class="fu">maxBound</span> v <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-15" title="15">  <span class="dt">BInt</span> (<span class="fu">maxBound</span>, <span class="fu">max</span> <span class="dv">0</span> <span class="fu">$</span> <span class="fu">min</span> <span class="fu">maxBound</span> v)</a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="ot">set ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">BInt</span> <span class="ot">-&gt;</span> <span class="dt">BInt</span></a>
<a class="sourceLine" id="cb1-19" title="19">set newValue (<span class="dt">BInt</span> (<span class="fu">maxBound</span>, _)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-20" title="20">  <span class="dt">BInt</span> (<span class="fu">maxBound</span>, <span class="fu">max</span> <span class="dv">0</span> <span class="fu">$</span> <span class="fu">min</span> <span class="fu">maxBound</span> newValue)</a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="ot">get ::</span> <span class="dt">BInt</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-24" title="24">get (<span class="dt">BInt</span> (_, v)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-25" title="25">  v</a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27"></a>
<a class="sourceLine" id="cb1-28" title="28"><span class="ot">getMax ::</span> <span class="dt">BInt</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-29" title="29">getMax (<span class="dt">BInt</span> (m, _)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-30" title="30">  m</a>
<a class="sourceLine" id="cb1-31" title="31"></a>
<a class="sourceLine" id="cb1-32" title="32"></a>
<a class="sourceLine" id="cb1-33" title="33"><span class="ot">update ::</span> (<span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">BInt</span> <span class="ot">-&gt;</span> <span class="dt">BInt</span></a>
<a class="sourceLine" id="cb1-34" title="34">update fn (<span class="dt">BInt</span> (<span class="fu">maxBound</span>, v)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-35" title="35">  <span class="dt">BInt</span> (<span class="fu">maxBound</span>, <span class="fu">max</span> <span class="dv">0</span> <span class="fu">.</span> <span class="fu">min</span> <span class="fu">maxBound</span> <span class="fu">$</span> fn v)</a></code></pre></div>
<p>Here is example of <em>BoundedInt</em> being used</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">BoundedInt</span> <span class="kw">as</span> <span class="dt">B</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">let</span> val1 <span class="fu">=</span> B.new <span class="dv">200</span> <span class="dv">100</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="fu">print</span> <span class="fu">$</span> B.get val1</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="ot"># &gt; 100</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">let</span> val2 <span class="fu">=</span> B.set <span class="dv">120</span> val1</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="fu">print</span> <span class="fu">$</span> B.get val2</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="ot"># &gt; 120</span></a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="kw">let</span> val3 <span class="fu">=</span> B.set <span class="dv">900</span> val2</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="fu">print</span> <span class="fu">$</span> B.get val3</a>
<a class="sourceLine" id="cb2-13" title="13"><span class="ot"># &gt; 200</span></a>
<a class="sourceLine" id="cb2-14" title="14"></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="kw">let</span> val4 <span class="fu">=</span> B.update (<span class="fu">subtract</span> <span class="dv">50</span>) val3</a>
<a class="sourceLine" id="cb2-16" title="16"><span class="fu">print</span> <span class="fu">$</span> B.get val4</a>
<a class="sourceLine" id="cb2-17" title="17"><span class="ot"># &gt; 150</span></a></code></pre></div>
<h1 id="preliminaries">Preliminaries</h1>
<p>The <em>World</em> type gets two new properties that store details about the energy system</p>
<h6 id="energysrcgamecore.hs-55-to-56">12_energy/src/GameCore.hs (55 to 56)</h6>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1">  ,<span class="ot"> _wdMinMoveEnergy ::</span> <span class="fu">!</span><span class="dt">Int</span>   <span class="co">-- ^ min energy required before any more, regardless of cost, can be attempted</span></a>
<a class="sourceLine" id="cb3-2" title="2">  ,<span class="ot"> _wdEnergyIncrements ::</span> <span class="fu">!</span><span class="dt">Int</span> <span class="co">-- ^ amount of energy that is added per game loop</span></a></code></pre></div>
<p>The <em>Actor</em> type gets three new properties</p>
<h6 id="energysrcgamecore.hs-36-to-38">12_energy/src/GameCore.hs (36 to 38)</h6>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1">  ,<span class="ot"> _acEnergy ::</span> <span class="fu">!</span><span class="dt">B.BInt</span> <span class="co">-- ^ available energy, bounded</span></a>
<a class="sourceLine" id="cb4-2" title="2">  ,<span class="ot"> _acMoveEnergyCost ::</span> <span class="fu">!</span><span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-3" title="3">  ,<span class="ot"> _acSkipMove ::</span> <span class="fu">!</span><span class="dt">Bool</span></a></code></pre></div>
<ul>
<li>acEnergy: The amount of energy the actor has available for a move</li>
<li>acMoveEnergyCost: The cost of each move for this actor</li>
<li>acSkipMove: True if the actor elects to skip a move, e.g. to store energy for a future move</li>
</ul>
<p><em>mkPlayer</em> and <em>mkEnemy</em> setup each of the actor classes</p>
<h6 id="energysrcgameengine.hs-151-to-153">12_energy/src/GameEngine.hs (151 to 153)</h6>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1">  , _acSkipMove <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb5-2" title="2">  , _acMoveEnergyCost <span class="fu">=</span> <span class="dv">100</span></a>
<a class="sourceLine" id="cb5-3" title="3">  , _acEnergy <span class="fu">=</span> B.new <span class="dv">200</span> <span class="dv">100</span></a></code></pre></div>
<h6 id="energysrcgameengine.hs-167-to-169">12_energy/src/GameEngine.hs (167 to 169)</h6>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1">  , _acSkipMove <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb6-2" title="2">  , _acMoveEnergyCost <span class="fu">=</span> <span class="dv">150</span></a>
<a class="sourceLine" id="cb6-3" title="3">  , _acEnergy <span class="fu">=</span> B.new <span class="dv">180</span> <span class="dv">100</span></a></code></pre></div>
<p>The <em>World</em> gets configured for the energy system</p>
<h6 id="energysrcgameengine.hs-96-to-97">12_energy/src/GameEngine.hs (96 to 97)</h6>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1">  , _wdMinMoveEnergy <span class="fu">=</span> <span class="dv">100</span></a>
<a class="sourceLine" id="cb7-2" title="2">  , _wdEnergyIncrements <span class="fu">=</span> <span class="dv">20</span></a></code></pre></div>
<p>We are also going to need a way to update an actor by id</p>
<h6 id="energysrcgameengine.hs-464-to-469">12_energy/src/GameEngine.hs (464 to 469)</h6>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="co">-- | Update either the player's actor, or one of the world actors</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="ot">updateActorById ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">Aid</span> <span class="ot">-&gt;</span> (<span class="dt">Actor</span> <span class="ot">-&gt;</span> <span class="dt">Actor</span>) <span class="ot">-&gt;</span> <span class="dt">World</span></a>
<a class="sourceLine" id="cb8-3" title="3">updateActorById w <span class="fu">id</span> update <span class="fu">=</span></a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="kw">if</span> w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acId <span class="fu">==</span> <span class="fu">id</span></a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="kw">then</span> w <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plActor) <span class="fu">.~</span> update (w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor) <span class="co">-- update the player's actor</span></a>
<a class="sourceLine" id="cb8-6" title="6">  <span class="kw">else</span> w <span class="fu">&amp;</span> wdActors <span class="fu">%~</span> Map.adjust update <span class="fu">id</span>                          <span class="co">-- update other actor, nop if aid not found</span></a></code></pre></div>
<h1 id="the-energy-system">The energy system</h1>
<p>On to the energy system logic. This code comment covers the overall picture, I’ll go into more detail below.</p>
<h6 id="energysrcgameengine.hs-632-to-685">12_energy/src/GameEngine.hs (632 to 685)</h6>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="co">-- | Manages the core logic of the energy system.</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">--    </span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">--       [key press] ------&gt; is zero cost move?</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">--                                |</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">--                                |</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">--              +--&lt;----yes-------+--&gt;--no-----+</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">--              |                              |</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">--              v                              |</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">--        +--&gt;(exit)                           |</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">--        |     ^                              |</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">--        |     |                              v</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co">--        |     +--&lt;----no--------player has min move energy?</span></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="co">--        |                          |         </span></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co">--        |                         yes</span></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="co">--        |                          |</span></a>
<a class="sourceLine" id="cb9-16" title="16"><span class="co">--        |                          v</span></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="co">--        |                      move player</span></a>
<a class="sourceLine" id="cb9-18" title="18"><span class="co">--        |                          |         </span></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">--        |                          v         </span></a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">--        +--&lt;---yes----player still has &gt; min move energy</span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co">--                         and is not skipping a move?</span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="co">--                                   |         </span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co">--                                  no</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="co">--                                   |</span></a>
<a class="sourceLine" id="cb9-25" title="25"><span class="co">--                                   v</span></a>
<a class="sourceLine" id="cb9-26" title="26"><span class="co">--                ###################################################</span></a>
<a class="sourceLine" id="cb9-27" title="27"><span class="co">--                #                  |                              #</span></a>
<a class="sourceLine" id="cb9-28" title="28"><span class="co">--                #                  v                              #</span></a>
<a class="sourceLine" id="cb9-29" title="29"><span class="co">--          +--&lt;--------player has &gt; min move energy &lt;--------+     #</span></a>
<a class="sourceLine" id="cb9-30" title="30"><span class="co">--          |     #                  |                        |     #</span></a>
<a class="sourceLine" id="cb9-31" title="31"><span class="co">--         yes    #                 no                        |     #</span></a>
<a class="sourceLine" id="cb9-32" title="32"><span class="co">--          |     #                  |                        |     #</span></a>
<a class="sourceLine" id="cb9-33" title="33"><span class="co">--          |     #                  v                        |     #</span></a>
<a class="sourceLine" id="cb9-34" title="34"><span class="co">--          |     #    move every non-player actor that       |     #</span></a>
<a class="sourceLine" id="cb9-35" title="35"><span class="co">--          |     #     has &gt; min move energy and has         |     #</span></a>
<a class="sourceLine" id="cb9-36" title="36"><span class="co">--          |     #     not elected to skip a move.           |     #</span></a>
<a class="sourceLine" id="cb9-37" title="37"><span class="co">--          |     #                  |                        |     #</span></a>
<a class="sourceLine" id="cb9-38" title="38"><span class="co">--          |     #                  |                        |     #</span></a>
<a class="sourceLine" id="cb9-39" title="39"><span class="co">--          |     #                  v                        |     #</span></a>
<a class="sourceLine" id="cb9-40" title="40"><span class="co">--          |     #     add wdEnergyIncrements to all actors--+     #</span></a>
<a class="sourceLine" id="cb9-41" title="41"><span class="co">--          |     #           including player's actor              #</span></a>
<a class="sourceLine" id="cb9-42" title="42"><span class="co">--          |     #                                                 #</span></a>
<a class="sourceLine" id="cb9-43" title="43"><span class="co">--          |     ###################################################</span></a>
<a class="sourceLine" id="cb9-44" title="44"><span class="co">--          |</span></a>
<a class="sourceLine" id="cb9-45" title="45"><span class="co">--          |</span></a>
<a class="sourceLine" id="cb9-46" title="46"><span class="co">--          +---------------&gt; set all actors skipMove = False</span></a>
<a class="sourceLine" id="cb9-47" title="47"><span class="co">--                                       |</span></a>
<a class="sourceLine" id="cb9-48" title="48"><span class="co">--                                       |</span></a>
<a class="sourceLine" id="cb9-49" title="49"><span class="co">--                                       v</span></a>
<a class="sourceLine" id="cb9-50" title="50"><span class="co">--                                     (exit)</span></a>
<a class="sourceLine" id="cb9-51" title="51"><span class="co">--  </span></a>
<a class="sourceLine" id="cb9-52" title="52"><span class="co">--  </span></a>
<a class="sourceLine" id="cb9-53" title="53"><span class="ot">playerMoving ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">World</span></a>
<a class="sourceLine" id="cb9-54" title="54">playerMoving pendingCost pendingWorld oldWorld <span class="fu">=</span> </a></code></pre></div>
<h2 id="chain-of-action-early-termination">Chain of action &amp; early termination</h2>
<p>To implement this logic I’m going to have a sequence of functions that need to be run. As you can see from the comment above may of these functions need a way to terminate the sequence rather than continuing.</p>
<pre><code>  s1 ----&gt; exit
   |   ^       
   v   |       
  s2 --+       
   |   ^       
   v   |       
  s3 --+       
   |           
   v           
  s4           </code></pre>
<p>This is exactly what <em>Either</em> and <code>&gt;&gt;=</code> give us. Remember that although <em>Either</em> is often used to denote success vs failure that is not what <em>Left</em> and <em>Right</em> <strong>mean</strong>. A <em>Right</em> value means continue the chain, a <em>Left</em> value means stop.</p>
<p>The type of <code>&gt;&gt;=</code> is</p>
<p><code>(&gt;&gt;=) :: Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b</code></p>
<p>In the examples below its being used with an <code>Either Int Int</code>, so the type is specialised to</p>
<p><code>(&gt;&gt;=) :: Either Int Int -&gt; (Int -&gt; Either Int Int) -&gt; Either Int Int</code></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="co">-- Runs to end</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="dt">Right</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>) </a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="fu">&gt;&gt;=</span> \v1 <span class="ot">-&gt;</span> (<span class="dt">Right</span> <span class="fu">$</span> v1 <span class="fu">+</span> <span class="dv">10</span>) </a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="fu">&gt;&gt;=</span> \v2 <span class="ot">-&gt;</span> (<span class="dt">Right</span> <span class="fu">$</span> v2 <span class="fu">+</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb11-5" title="5">  </a>
<a class="sourceLine" id="cb11-6" title="6"><span class="ot">#&gt; Right 111</span></a></code></pre></div>
<ol type="1">
<li>Start with a <code>Right 1</code></li>
<li><code>&gt;&gt;=</code> gets the <em>Right</em>, continues, lambda given <code>1</code>, lambda returns <code>Right $ 1 + 10</code></li>
<li><code>&gt;&gt;=</code> gets the <em>Right</em>, continues, lambda given <code>11</code>, lambda returns <code>Right $ 11 + 100</code></li>
<li>Final result is <code>Right 111</code></li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1"><span class="co">-- Stops early</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="dt">Right</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>) </a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="fu">&gt;&gt;=</span> \v1 <span class="ot">-&gt;</span> (<span class="dt">Left</span> <span class="fu">$</span> v1 <span class="fu">+</span> <span class="dv">10</span>) </a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="fu">&gt;&gt;=</span> \v2 <span class="ot">-&gt;</span> (<span class="dt">Right</span> <span class="fu">$</span> v2 <span class="fu">+</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb12-5" title="5">  </a>
<a class="sourceLine" id="cb12-6" title="6"><span class="ot">#&gt; Left 11</span></a></code></pre></div>
<ol type="1">
<li>Start with a <code>Right 1</code></li>
<li><code>&gt;&gt;=</code> gets the <em>Right</em>, continues, lambda given <code>1</code>, lambda returns <code>Left $ 1 + 10</code></li>
<li><code>&gt;&gt;=</code> gets the <em>Left</em>, stops</li>
<li>Final result is <code>Left 11</code></li>
</ol>
<h2 id="logic---top-half">Logic - top half</h2>
<p>This code corresponds to the top half of the flow diagram in the comment. Here you can see <code>&gt;&gt;=</code> used to chain the sequence.</p>
<h6 id="energysrcgameengine.hs-688-to-693">12_energy/src/GameEngine.hs (688 to 693)</h6>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">  <span class="kw">let</span> playerAttemptedMoveWorld <span class="fu">=</span> </a>
<a class="sourceLine" id="cb13-2" title="2">        <span class="dt">Right</span> oldWorld</a>
<a class="sourceLine" id="cb13-3" title="3">          <span class="fu">&gt;&gt;=</span> checkIfNonMove</a>
<a class="sourceLine" id="cb13-4" title="4">          <span class="fu">&gt;&gt;=</span> checkIfPlayerHasMinEnergy</a>
<a class="sourceLine" id="cb13-5" title="5">          <span class="fu">&gt;&gt;=</span> runPendingIfPlayerHasEnergy</a>
<a class="sourceLine" id="cb13-6" title="6">          <span class="fu">&gt;&gt;=</span> stopIfPlayerCanStillMove</a></code></pre></div>
<ol type="1">
<li>Check for a non-move (zero cost)</li>
<li>Check if the player has at least the min-move-energy</li>
<li>Perform the move if the player has enough energy</li>
<li>If the player can move again then stop</li>
</ol>
<h2 id="logic---bottom-half">Logic - bottom half</h2>
<p>This code corresponds to the bottom half of the flow diagram in the comment.</p>
<p>We start with the <code>Either World World</code> from above. If the value is <code>Left World</code> then stop and return the world, if its a <code>Right World</code> then continue.</p>
<p>Here <code>&amp;</code>, the reverse application operator, is being used to combine the functions. In other languages you may have seen this called <code>|&gt;</code>.</p>
<p>E.g.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="co">-- (&amp;) :: a -&gt; (a -&gt; b) -&gt; b</span></a>
<a class="sourceLine" id="cb14-2" title="2">(<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>) <span class="fu">&amp;</span> (<span class="fu">+</span> <span class="dv">5</span>) <span class="fu">&amp;</span> (<span class="fu">+</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="fu">&gt;</span><span class="dv">16</span></a></code></pre></div>
<p>It is called the reverse application operator as it applies the calls opposite to the way you usually would e.g by using <code>.</code></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1">(<span class="fu">+</span> <span class="dv">10</span>) <span class="fu">.</span> (<span class="fu">+</span> <span class="dv">5</span>) <span class="fu">$</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="fu">&gt;</span><span class="dv">16</span></a></code></pre></div>
<p>I chose to use it here as it mirrors the flow of the <code>&gt;&gt;=</code> chain above.</p>
<h6 id="energysrcgameengine.hs-697-to-704">12_energy/src/GameEngine.hs (697 to 704)</h6>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1">  <span class="kw">case</span> playerAttemptedMoveWorld <span class="kw">of</span></a>
<a class="sourceLine" id="cb16-2" title="2">    <span class="dt">Left</span> w <span class="ot">-&gt;</span> w <span class="co">-- Left means stop </span></a>
<a class="sourceLine" id="cb16-3" title="3">    <span class="dt">Right</span> w <span class="ot">-&gt;</span>  <span class="co">-- Right means continue with other actors</span></a>
<a class="sourceLine" id="cb16-4" title="4">      <span class="co">-- Loop, adding energy (wdEnergyincrements) to all actors until the player has enough energy to move</span></a>
<a class="sourceLine" id="cb16-5" title="5">      storeSkipTurnEnergy w</a>
<a class="sourceLine" id="cb16-6" title="6">      <span class="fu">&amp;</span> runNonPlayerActorLoop</a>
<a class="sourceLine" id="cb16-7" title="7">      <span class="fu">&amp;</span> restoreSkipTurnEnergy</a>
<a class="sourceLine" id="cb16-8" title="8">      <span class="fu">&amp;</span> disableSkip</a></code></pre></div>
<ol type="1">
<li>Store the player energy level</li>
<li>Run non-player loop</li>
<li>Restore the players energy</li>
<li>Set skip-move to False for all actors</li>
</ol>
<h2 id="code-top-half">Code top half</h2>
<p>The code and comments for the first half of the code should be reasonably self-explanatory.</p>
<h6 id="energysrcgameengine.hs-709-to-739">12_energy/src/GameEngine.hs (709 to 739)</h6>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1">    checkIfNonMove w <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-2" title="2">      <span class="co">-- If the cost is zero/negative then this is not an actual move</span></a>
<a class="sourceLine" id="cb17-3" title="3">      <span class="co">--  Apply the pending action and continue</span></a>
<a class="sourceLine" id="cb17-4" title="4">      <span class="kw">if</span> pendingCost <span class="fu">&lt;=</span> <span class="dv">0</span> <span class="fu">&amp;&amp;</span> <span class="fu">not</span> (pendingWorld <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acSkipMove)</a>
<a class="sourceLine" id="cb17-5" title="5">      <span class="kw">then</span> <span class="dt">Left</span> pendingWorld</a>
<a class="sourceLine" id="cb17-6" title="6">      <span class="kw">else</span> <span class="dt">Right</span> w</a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8">    checkIfPlayerHasMinEnergy w <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-9" title="9">      <span class="kw">if</span> B.get (w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acEnergy) <span class="fu">&gt;=</span> w <span class="fu">^.</span> wdMinMoveEnergy</a>
<a class="sourceLine" id="cb17-10" title="10">      <span class="kw">then</span> <span class="dt">Right</span> w <span class="co">-- continue</span></a>
<a class="sourceLine" id="cb17-11" title="11">      <span class="kw">else</span> <span class="dt">Left</span> w  <span class="co">-- not enough energy to move regardless of move cost</span></a>
<a class="sourceLine" id="cb17-12" title="12">    </a>
<a class="sourceLine" id="cb17-13" title="13">    runPendingIfPlayerHasEnergy w <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-14" title="14">      <span class="kw">if</span> B.get (w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acEnergy) <span class="fu">&gt;=</span> pendingCost</a>
<a class="sourceLine" id="cb17-15" title="15">      <span class="kw">then</span></a>
<a class="sourceLine" id="cb17-16" title="16">        <span class="co">-- perform move and subtract energy</span></a>
<a class="sourceLine" id="cb17-17" title="17">        <span class="dt">Right</span> (pendingWorld <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plActor <span class="fu">.</span> acEnergy) <span class="fu">%~</span> B.update (<span class="fu">subtract</span> pendingCost))</a>
<a class="sourceLine" id="cb17-18" title="18">      <span class="kw">else</span></a>
<a class="sourceLine" id="cb17-19" title="19">        <span class="co">-- disallow</span></a>
<a class="sourceLine" id="cb17-20" title="20">        <span class="dt">Left</span> w</a>
<a class="sourceLine" id="cb17-21" title="21"></a>
<a class="sourceLine" id="cb17-22" title="22">    stopIfPlayerCanStillMove w <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-23" title="23">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb17-24" title="24">        a <span class="fu">=</span> w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor </a>
<a class="sourceLine" id="cb17-25" title="25">        hasEnergy <span class="fu">=</span> B.get (a <span class="fu">^.</span> acEnergy) <span class="fu">&gt;</span> a <span class="fu">^.</span> acMoveEnergyCost </a>
<a class="sourceLine" id="cb17-26" title="26">        skipMove <span class="fu">=</span> a <span class="fu">^.</span> acSkipMove </a>
<a class="sourceLine" id="cb17-27" title="27">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb17-28" title="28">      <span class="kw">if</span></a>
<a class="sourceLine" id="cb17-29" title="29">        <span class="fu">|</span> skipMove <span class="ot">-&gt;</span> <span class="dt">Right</span> w <span class="co">-- The player elected to skip a move, continue with others</span></a>
<a class="sourceLine" id="cb17-30" title="30">        <span class="fu">|</span> hasEnergy <span class="ot">-&gt;</span> <span class="dt">Left</span> w <span class="co">-- The player has energy, its still their turn</span></a>
<a class="sourceLine" id="cb17-31" title="31">        <span class="fu">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="dt">Right</span> w <span class="co">-- continue</span></a></code></pre></div>
<h2 id="code-bottom-half">Code bottom half</h2>
<p>There is a bit more going on here, so I’ll cover function by function in order of execution. Remember that these all run, there is no early termination as we are using <code>&amp;</code> not <code>&gt;&gt;=</code></p>
<h3 id="storeskipturnenergy">storeSkipTurnEnergy</h3>
<h6 id="energysrcgameengine.hs-797-to-805">12_energy/src/GameEngine.hs (797 to 805)</h6>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1">  storeSkipTurnEnergy w <span class="fu">=</span></a>
<a class="sourceLine" id="cb18-2" title="2">    <span class="kw">if</span> w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acSkipMove</a>
<a class="sourceLine" id="cb18-3" title="3">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb18-4" title="4">      <span class="co">-- Store the player's current energy, and set the energy level to zero</span></a>
<a class="sourceLine" id="cb18-5" title="5">      <span class="co">-- This lets the actor movement loop run for a full set of turns up to the min energy level</span></a>
<a class="sourceLine" id="cb18-6" title="6">      w <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plPendingEnergy) <span class="fu">.~</span> B.get (w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acEnergy)</a>
<a class="sourceLine" id="cb18-7" title="7">        <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plActor <span class="fu">.</span> acEnergy) <span class="fu">%~</span> B.set <span class="dv">0</span></a>
<a class="sourceLine" id="cb18-8" title="8">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb18-9" title="9">      w</a></code></pre></div>
<ol type="1">
<li>If the player is skipping a move, the stop</li>
<li>Otherwise
<ol type="1">
<li>Store the player’s energy in <em>plPendingEnergy</em></li>
<li>Set the player’s energy to zero</li>
</ol></li>
</ol>
<p>The player’s energy is set to zero here so that in the code below we add the <em>wdEnergyIncrements</em> up to <em>wdMinMoveEnergy</em> to give the non-player actors a fair chance to make one full move.</p>
<h3 id="runnonplayeractorloop">runNonPlayerActorLoop</h3>
<h6 id="energysrcgameengine.hs-743-to-754">12_energy/src/GameEngine.hs (743 to 754)</h6>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1">  runNonPlayerActorLoop w <span class="fu">=</span></a>
<a class="sourceLine" id="cb19-2" title="2">    <span class="kw">if</span> B.get (w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acEnergy) <span class="fu">&gt;=</span> w <span class="fu">^.</span> wdMinMoveEnergy</a>
<a class="sourceLine" id="cb19-3" title="3">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb19-4" title="4">      w <span class="co">-- The player now has enough energy to move, stop loop</span></a>
<a class="sourceLine" id="cb19-5" title="5">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb19-6" title="6">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb19-7" title="7">        <span class="co">-- Move actors</span></a>
<a class="sourceLine" id="cb19-8" title="8">        w' <span class="fu">=</span> moveAllNonPlayers w </a>
<a class="sourceLine" id="cb19-9" title="9">        <span class="co">-- Add energy for next loop</span></a>
<a class="sourceLine" id="cb19-10" title="10">        addEnergy _ a <span class="fu">=</span> a <span class="fu">&amp;</span> acEnergy <span class="fu">%~</span> B.update ((w' <span class="fu">^.</span> wdEnergyIncrements) <span class="fu">+</span>)</a>
<a class="sourceLine" id="cb19-11" title="11">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb19-12" title="12">      runNonPlayerActorLoop <span class="fu">$</span> updateAllActors w' addEnergy</a></code></pre></div>
<p>This function calls itself recursively, adding <em>wdEnergyIncrements</em> to each actor, until the player has at least <em>wdMinMoveEnergy</em></p>
<ol type="1">
<li>Check if the player has <em>wdMinMoveEnergy</em> if so stop recursion</li>
<li>Otherwise
<ol type="1">
<li>Give all non-players a chance to move (see <em>moveAllNonPlayers</em> below)</li>
<li>Add <em>wdEnergyIncrements</em> to all actors</li>
<li>loop</li>
</ol></li>
</ol>
<h3 id="moveallnonplayers">moveAllNonPlayers</h3>
<p>Our actors are going to be pretty dim for now, they just try to move in a random direction. We’ll get to AI later on.</p>
<h6 id="energysrcgameengine.hs-758-to-793">12_energy/src/GameEngine.hs (758 to 793)</h6>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1">    moveAllNonPlayers w <span class="fu">=</span></a>
<a class="sourceLine" id="cb20-2" title="2">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb20-3" title="3">        <span class="co">-- Random directions the actors could move in (no diagonal moves)</span></a>
<a class="sourceLine" id="cb20-4" title="4">        directions <span class="fu">=</span> [(<span class="fu">-</span><span class="dv">1</span>,<span class="dv">0</span>), (<span class="dv">0</span>,<span class="fu">-</span><span class="dv">1</span>), (<span class="dv">0</span>,<span class="dv">1</span>), (<span class="dv">1</span>,<span class="dv">0</span>)]</a>
<a class="sourceLine" id="cb20-5" title="5">  </a>
<a class="sourceLine" id="cb20-6" title="6">        <span class="co">-- Other actors just try to move in random directions</span></a>
<a class="sourceLine" id="cb20-7" title="7">        mv aOrig wOrig <span class="fu">=</span></a>
<a class="sourceLine" id="cb20-8" title="8">          <span class="kw">let</span></a>
<a class="sourceLine" id="cb20-9" title="9">            <span class="co">-- Pick a random direction to move</span></a>
<a class="sourceLine" id="cb20-10" title="10">            (dir, nextStd) <span class="fu">=</span> randomElement (aOrig <span class="fu">^.</span> acStdGen) directions </a>
<a class="sourceLine" id="cb20-11" title="11">            <span class="co">-- Try move, i.e. if there is no wall / actor in the way</span></a>
<a class="sourceLine" id="cb20-12" title="12">            w2 <span class="fu">=</span> tryMoveActor wOrig aOrig <span class="fu">$</span> fromMaybe (<span class="dv">0</span>, <span class="dv">0</span>) dir</a>
<a class="sourceLine" id="cb20-13" title="13">          <span class="kw">in</span></a>
<a class="sourceLine" id="cb20-14" title="14">          <span class="kw">case</span> w2 <span class="kw">of</span></a>
<a class="sourceLine" id="cb20-15" title="15">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb20-16" title="16">              <span class="co">-- Unable to move, so skip a turn. This accumulates energy for the next attempt</span></a>
<a class="sourceLine" id="cb20-17" title="17">              <span class="co">--  Also update the stdgen for the next time a random number is needed</span></a>
<a class="sourceLine" id="cb20-18" title="18">              updateActor wOrig <span class="fu">$</span> aOrig <span class="fu">&amp;</span> acSkipMove <span class="fu">.~</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb20-19" title="19">                                        <span class="fu">&amp;</span> acStdGen <span class="fu">.~</span> nextStd</a>
<a class="sourceLine" id="cb20-20" title="20"></a>
<a class="sourceLine" id="cb20-21" title="21">            <span class="dt">Just</span> w2' <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb20-22" title="22">              <span class="co">-- The actor moved, use the new world but remember to update the stdgen</span></a>
<a class="sourceLine" id="cb20-23" title="23">              updateActorById w2' (aOrig <span class="fu">^.</span> acId) (\a <span class="ot">-&gt;</span> a <span class="fu">&amp;</span> acStdGen <span class="fu">.~</span> nextStd)</a>
<a class="sourceLine" id="cb20-24" title="24"></a>
<a class="sourceLine" id="cb20-25" title="25">        <span class="co">-- All actors that have enough energy to move and are not skipping a turn</span></a>
<a class="sourceLine" id="cb20-26" title="26">        actorsThatCanMove <span class="fu">=</span> <span class="fu">filter</span></a>
<a class="sourceLine" id="cb20-27" title="27">                            (\a <span class="ot">-&gt;</span> B.get (a <span class="fu">^.</span> acEnergy) <span class="fu">&gt;=</span> (w <span class="fu">^.</span> wdMinMoveEnergy) <span class="fu">&amp;&amp;</span> <span class="fu">not</span> (a <span class="fu">^.</span> acSkipMove))</a>
<a class="sourceLine" id="cb20-28" title="28">                            (Map.elems <span class="fu">$</span> w <span class="fu">^.</span> wdActors)</a>
<a class="sourceLine" id="cb20-29" title="29">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb20-30" title="30">      <span class="co">-- Are the any actors that could still move?</span></a>
<a class="sourceLine" id="cb20-31" title="31">      <span class="kw">if</span> <span class="fu">null</span> actorsThatCanMove</a>
<a class="sourceLine" id="cb20-32" title="32">      <span class="kw">then</span></a>
<a class="sourceLine" id="cb20-33" title="33">        w <span class="co">-- No one left, done</span></a>
<a class="sourceLine" id="cb20-34" title="34">      <span class="kw">else</span></a>
<a class="sourceLine" id="cb20-35" title="35">        <span class="co">-- Give actors that are able to move a chance to move</span></a>
<a class="sourceLine" id="cb20-36" title="36">        <span class="fu">foldr</span> mv w actorsThatCanMove</a></code></pre></div>
<h6 id="energysrcgameengine.hs-825-to-828">12_energy/src/GameEngine.hs (825 to 828)</h6>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1"><span class="ot">randomElement ::</span> <span class="dt">Rnd.StdGen</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> (<span class="dt">Maybe</span> a, <span class="dt">Rnd.StdGen</span>)</a>
<a class="sourceLine" id="cb21-2" title="2">randomElement g as <span class="fu">=</span></a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="kw">let</span> (i, next) <span class="fu">=</span> Rnd.randomR (<span class="dv">0</span>, <span class="fu">length</span> as <span class="fu">-</span> <span class="dv">1</span>) g <span class="kw">in</span></a>
<a class="sourceLine" id="cb21-4" title="4">  (atMay as i, next)</a></code></pre></div>
<ul>
<li><em>randomElement</em> gets a random direction to move and returns the next <em>StdGen</em> which must be saved in the actor</li>
<li>Once an actor can’t move set its <em>acSkipTurn</em> to True. This lets it accumulate energy without moving before the player moves again</li>
<li>Call <em>mv</em> until there are no actors that can move</li>
</ul>
<h3 id="restoreskipturnenergy">restoreSkipTurnEnergy</h3>
<h6 id="energysrcgameengine.hs-809-to-815">12_energy/src/GameEngine.hs (809 to 815)</h6>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1">  restoreSkipTurnEnergy w <span class="fu">=</span></a>
<a class="sourceLine" id="cb22-2" title="2">    <span class="kw">if</span> w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acSkipMove</a>
<a class="sourceLine" id="cb22-3" title="3">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb22-4" title="4">      <span class="co">-- Restore and pending energy, up to the player's max energy level</span></a>
<a class="sourceLine" id="cb22-5" title="5">      w <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plActor <span class="fu">.</span> acEnergy) <span class="fu">%~</span> B.update ((w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plPendingEnergy) <span class="fu">+</span>)</a>
<a class="sourceLine" id="cb22-6" title="6">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb22-7" title="7">      w</a></code></pre></div>
<p>*. Restore the players energy</p>
<h3 id="disableskip">disableSkip</h3>
<h6 id="energysrcgameengine.hs-819-to-820">12_energy/src/GameEngine.hs (819 to 820)</h6>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1">  disableSkip w <span class="fu">=</span></a>
<a class="sourceLine" id="cb23-2" title="2">    updateAllActors w (\_ a <span class="ot">-&gt;</span> a <span class="fu">&amp;</span> acSkipMove <span class="fu">.~</span> <span class="dt">False</span>)</a></code></pre></div>
<p><em>. Set </em>acSkipMove* to False for all actors</p>
<h1 id="running-the-energy-system">Running the energy system</h1>
<p>The energy system logic run each time a key is pressed (in <em>runCmd</em>)</p>
<h6 id="energysrcgameengine.hs-187-to-199">12_energy/src/GameEngine.hs (187 to 199)</h6>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1">  <span class="st">&quot;key&quot;</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb24-2" title="2">    <span class="co">-- Handle the key press</span></a>
<a class="sourceLine" id="cb24-3" title="3">    atomically <span class="fu">$</span> modifyTVar' worldV (\w <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-4" title="4">                                       <span class="co">-- Do the actions as if they will succeed</span></a>
<a class="sourceLine" id="cb24-5" title="5">                                       <span class="kw">let</span> pendingWorld <span class="fu">=</span> runActions w <span class="fu">$</span> handleKey w cmdData <span class="kw">in</span></a>
<a class="sourceLine" id="cb24-6" title="6">                                       <span class="co">-- Apply, if the move is allowed</span></a>
<a class="sourceLine" id="cb24-7" title="7">                                       <span class="co">-- Cost is hard-coded to 100 for now, this will be fixed later</span></a>
<a class="sourceLine" id="cb24-8" title="8">                                       playerMoving <span class="dv">100</span> pendingWorld w</a>
<a class="sourceLine" id="cb24-9" title="9">                                    )</a>
<a class="sourceLine" id="cb24-10" title="10">    <span class="co">-- Get the updated world</span></a>
<a class="sourceLine" id="cb24-11" title="11">    w2 <span class="ot">&lt;-</span> atomically <span class="fu">$</span> readTVar worldV</a>
<a class="sourceLine" id="cb24-12" title="12">    <span class="co">-- Draw</span></a>
<a class="sourceLine" id="cb24-13" title="13">    drawAndSend w2</a></code></pre></div>
<p>Notice that the actions are run, assuming that they will succeed. <em>playerMoving</em> (the energy system) is then called and if allowed the pending world is used. If not then the old world is.</p>
<h2 id="result">Result</h2>
<p>That was a large chunk of code but it adds a major part of the game logic.</p>
<p><img src="../../images/rogue_12_random.gif" /></p>
<p>You can see the non-player actors moving randomly around and the snake is faster than the player so gets multiple moves. Next we’ll give the actors some intelligence.</p>
<h1 id="chapters">Chapters</h1>
<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_11.html">prev</a> <a href="2018-04-02-haskell-rogue-like_13.html">next</a></p>
<h1 id="changes">Changes</h1>
<div class="wrapper">
<h2 class=".diffh2">
src/BoundedInt.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b --new-file 11_sticky_light/src/BoundedInt.hs 12_energy/src/BoundedInt.hs</pre>
<pre class="diffpre delete">--- 11_sticky_light/src/BoundedInt.hs</pre>
<pre class="diffpre insert">+++ 12_energy/src/BoundedInt.hs</pre>
<pre class="diffpre info">@@ -0,0 +1,39 @@</pre>
<pre class="diffpre insert">+{-# LANGUAGE NoImplicitPrelude #-}</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+module BoundedInt ( BInt</pre>
<pre class="diffpre insert">+                  , new</pre>
<pre class="diffpre insert">+                  , update</pre>
<pre class="diffpre insert">+                  , set</pre>
<pre class="diffpre insert">+                  , get</pre>
<pre class="diffpre insert">+                  , getMax</pre>
<pre class="diffpre insert">+                  ) where</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+import Protolude hiding (maxBound, get)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+newtype BInt = BInt (Int, Int) deriving (Eq, Show)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+new :: Int -&gt; Int -&gt; BInt</pre>
<pre class="diffpre insert">+new maxBound v =</pre>
<pre class="diffpre insert">+  BInt (maxBound, max 0 $ min maxBound v)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+set :: Int -&gt; BInt -&gt; BInt</pre>
<pre class="diffpre insert">+set newValue (BInt (maxBound, _)) =</pre>
<pre class="diffpre insert">+  BInt (maxBound, max 0 $ min maxBound newValue)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+get :: BInt -&gt; Int</pre>
<pre class="diffpre insert">+get (BInt (_, v)) =</pre>
<pre class="diffpre insert">+  v</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+getMax :: BInt -&gt; Int</pre>
<pre class="diffpre insert">+getMax (BInt (m, _)) =</pre>
<pre class="diffpre insert">+  m</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+update :: (Int -&gt; Int) -&gt; BInt -&gt; BInt</pre>
<pre class="diffpre insert">+update fn (BInt (maxBound, v)) =</pre>
<pre class="diffpre insert">+  BInt (maxBound, max 0 . min maxBound $ fn v)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">Common subdirectories: 11_sticky_light/src/Data and 12_energy/src/Data</pre>
</div>
<h2 class=".diffh2">
src/GameCore.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b --new-file 11_sticky_light/src/GameCore.hs 12_energy/src/GameCore.hs</pre>
<pre class="diffpre delete">--- 11_sticky_light/src/GameCore.hs</pre>
<pre class="diffpre insert">+++ 12_energy/src/GameCore.hs</pre>
<pre class="diffpre info">@@ -16,6 +16,7 @@</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> import qualified GameHost as Host</pre>
<pre class="diffpre context"> import qualified EntityType as E</pre>
<pre class="diffpre insert">+import qualified BoundedInt as B</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data ActorClass = ClassPlayer</pre>
<pre class="diffpre context">                 | ClassEnemy</pre>
<pre class="diffpre info">@@ -29,10 +30,13 @@</pre>
<pre class="diffpre context">                    , _acWorldPos :: !WorldPos</pre>
<pre class="diffpre context">                    , _acStdGen :: !Rnd.StdGen</pre>
<pre class="diffpre context">                    , _acFov :: !(Maybe [(WorldPos, [WorldPos])])</pre>
<pre class="diffpre delete">-</pre>
<pre class="diffpre context">                    , _acFovHistory :: !(Set WorldPos)</pre>
<pre class="diffpre delete">-</pre>
<pre class="diffpre context">                    , _acFovDistance :: !Int</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+                   , _acEnergy :: !B.BInt -- ^ available energy, bounded</pre>
<pre class="diffpre insert">+                   , _acMoveEnergyCost :: !Int</pre>
<pre class="diffpre insert">+                   , _acSkipMove :: !Bool</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">                    }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data Player = Player { _plConn :: !Host.Connection</pre>
<pre class="diffpre info">@@ -40,12 +44,17 @@</pre>
<pre class="diffpre context">                      , _plScreenSize :: !(Int, Int)</pre>
<pre class="diffpre context">                      , _plWorldTopLeft :: !WorldPos</pre>
<pre class="diffpre context">                      , _plViewPortStyle :: !ViewPortStyle</pre>
<pre class="diffpre insert">+                     , _plPendingEnergy :: !Int</pre>
<pre class="diffpre context">                      }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data World = World { _wdPlayer :: !Player</pre>
<pre class="diffpre context">                    , _wdConfig :: !Config</pre>
<pre class="diffpre context">                    , _wdMap :: !(Map WorldPos Entity)</pre>
<pre class="diffpre context">                    , _wdActors :: !(Map Aid Actor)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+                   , _wdMinMoveEnergy :: !Int   -- ^ min energy required before any more, regardless of cost, can be attempted</pre>
<pre class="diffpre insert">+                   , _wdEnergyIncrements :: !Int -- ^ amount of energy that is added per game loop</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">                    }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data Config = Config { _cfgKeys :: !(Map Text Text)</pre>
</div>
<h2 class=".diffh2">
src/GameEngine.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b --new-file 11_sticky_light/src/GameEngine.hs 12_energy/src/GameEngine.hs</pre>
<pre class="diffpre delete">--- 11_sticky_light/src/GameEngine.hs</pre>
<pre class="diffpre insert">+++ 12_energy/src/GameEngine.hs</pre>
<pre class="diffpre info">@@ -26,6 +26,7 @@</pre>
<pre class="diffpre context"> import           GameHost (conSendData, conReceiveText)</pre>
<pre class="diffpre context"> import qualified Entities as E</pre>
<pre class="diffpre context"> import qualified EntityType as E</pre>
<pre class="diffpre insert">+import qualified BoundedInt as B</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> runGame :: IO ()</pre>
<pre class="diffpre info">@@ -91,6 +92,10 @@</pre>
<pre class="diffpre context">                , _wdActors = Map.fromList [ (bug ^. acId, bug)</pre>
<pre class="diffpre context">                                           , (snake ^. acId, snake)</pre>
<pre class="diffpre context">                                           ]</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+               , _wdMinMoveEnergy = 100</pre>
<pre class="diffpre insert">+               , _wdEnergyIncrements = 20</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">                }</pre>
<pre class="diffpre context">   in</pre>
<pre class="diffpre context">   -- Calculate the actors fov</pre>
<pre class="diffpre info">@@ -130,6 +135,7 @@</pre>
<pre class="diffpre context">              , _plWorldTopLeft = WorldPos (0, 0)</pre>
<pre class="diffpre context">              , _plActor = mkPlayersActor</pre>
<pre class="diffpre context">              , _plViewPortStyle = ViewPortBorder 2</pre>
<pre class="diffpre insert">+             , _plPendingEnergy = 0</pre>
<pre class="diffpre context">              }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context">     mkPlayersActor =</pre>
<pre class="diffpre info">@@ -141,6 +147,11 @@</pre>
<pre class="diffpre context">             , _acFovDistance = 3</pre>
<pre class="diffpre context">             , _acFov = Nothing</pre>
<pre class="diffpre context">             , _acFovHistory = Set.empty</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+            , _acSkipMove = False</pre>
<pre class="diffpre insert">+            , _acMoveEnergyCost = 100</pre>
<pre class="diffpre insert">+            , _acEnergy = B.new 200 100</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">             }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context">     mkEnemyActor aid e (x, y) =</pre>
<pre class="diffpre info">@@ -152,6 +163,11 @@</pre>
<pre class="diffpre context">             , _acFovDistance = 2</pre>
<pre class="diffpre context">             , _acFov = Nothing</pre>
<pre class="diffpre context">             , _acFovHistory = Set.empty</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+            , _acSkipMove = False</pre>
<pre class="diffpre insert">+            , _acMoveEnergyCost = 150</pre>
<pre class="diffpre insert">+            , _acEnergy = B.new 180 100</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">             }</pre>
<pre class="diffpre context">     </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre info">@@ -167,9 +183,16 @@</pre>
<pre class="diffpre context">           drawAndSend w</pre>
<pre class="diffpre context">           sendLog conn "draw"</pre>
<pre class="diffpre context">       </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">     "key" -&gt; do</pre>
<pre class="diffpre context">       -- Handle the key press</pre>
<pre class="diffpre delete">-      atomically $ modifyTVar' worldV (\w -&gt; runActions w $ handleKey w cmdData)</pre>
<pre class="diffpre insert">+      atomically $ modifyTVar' worldV (\w -&gt;</pre>
<pre class="diffpre insert">+                                         -- Do the actions as if they will succeed</pre>
<pre class="diffpre insert">+                                         let pendingWorld = runActions w $ handleKey w cmdData in</pre>
<pre class="diffpre insert">+                                         -- Apply, if the move is allowed</pre>
<pre class="diffpre insert">+                                         -- Cost is hard-coded to 100 for now, this will be fixed later</pre>
<pre class="diffpre insert">+                                         playerMoving 100 pendingWorld w</pre>
<pre class="diffpre insert">+                                      )</pre>
<pre class="diffpre context">       -- Get the updated world</pre>
<pre class="diffpre context">       w2 &lt;- atomically $ readTVar worldV</pre>
<pre class="diffpre context">       -- Draw</pre>
<pre class="diffpre info">@@ -437,6 +460,16 @@</pre>
<pre class="diffpre context">   else w &amp; wdActors %~ Map.adjust (const actor) (actor ^. acId)  -- update other actor, nop if aid not found</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context">   </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+-- | Update either the player's actor, or one of the world actors</pre>
<pre class="diffpre insert">+updateActorById :: World -&gt; Aid -&gt; (Actor -&gt; Actor) -&gt; World</pre>
<pre class="diffpre insert">+updateActorById w id update =</pre>
<pre class="diffpre insert">+  if w ^. wdPlayer ^. plActor ^. acId == id</pre>
<pre class="diffpre insert">+  then w &amp; (wdPlayer . plActor) .~ update (w ^. wdPlayer ^. plActor) -- update the player's actor</pre>
<pre class="diffpre insert">+  else w &amp; wdActors %~ Map.adjust update id                          -- update other actor, nop if aid not found</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  </pre>
<pre class="diffpre context"> -- | Update all actors, including the player's actor</pre>
<pre class="diffpre context"> updateAllActors :: World -&gt; (World -&gt; Actor -&gt; Actor) -&gt; World</pre>
<pre class="diffpre context"> updateAllActors w fn =</pre>
<pre class="diffpre info">@@ -591,7 +623,207 @@</pre>
<pre class="diffpre context">   foldr Map.delete blackBg $ lightAt &lt;&gt; seen</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-  </pre>
<pre class="diffpre context"> flatFov :: Maybe [(WorldPos, [WorldPos])] -&gt; [WorldPos]</pre>
<pre class="diffpre context"> flatFov Nothing = []</pre>
<pre class="diffpre context"> flatFov (Just fov) = Lst.nub . Lst.concat $ snd &lt;$&gt; fov</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+-- | Manages the core logic of the energy system.</pre>
<pre class="diffpre insert">+--    </pre>
<pre class="diffpre insert">+--       [key press] ------&gt; is zero cost move?</pre>
<pre class="diffpre insert">+--                                |</pre>
<pre class="diffpre insert">+--                                |</pre>
<pre class="diffpre insert">+--              +--&lt;----yes-------+--&gt;--no-----+</pre>
<pre class="diffpre insert">+--              |                              |</pre>
<pre class="diffpre insert">+--              v                              |</pre>
<pre class="diffpre insert">+--        +--&gt;(exit)                           |</pre>
<pre class="diffpre insert">+--        |     ^                              |</pre>
<pre class="diffpre insert">+--        |     |                              v</pre>
<pre class="diffpre insert">+--        |     +--&lt;----no--------player has min move energy?</pre>
<pre class="diffpre insert">+--        |                          |         </pre>
<pre class="diffpre insert">+--        |                         yes</pre>
<pre class="diffpre insert">+--        |                          |</pre>
<pre class="diffpre insert">+--        |                          v</pre>
<pre class="diffpre insert">+--        |                      move player</pre>
<pre class="diffpre insert">+--        |                          |         </pre>
<pre class="diffpre insert">+--        |                          v         </pre>
<pre class="diffpre insert">+--        +--&lt;---yes----player still has &gt; min move energy</pre>
<pre class="diffpre insert">+--                         and is not skipping a move?</pre>
<pre class="diffpre insert">+--                                   |         </pre>
<pre class="diffpre insert">+--                                  no</pre>
<pre class="diffpre insert">+--                                   |</pre>
<pre class="diffpre insert">+--                                   v</pre>
<pre class="diffpre insert">+--                ###################################################</pre>
<pre class="diffpre insert">+--                #                  |                              #</pre>
<pre class="diffpre insert">+--                #                  v                              #</pre>
<pre class="diffpre insert">+--          +--&lt;--------player has &gt; min move energy &lt;--------+     #</pre>
<pre class="diffpre insert">+--          |     #                  |                        |     #</pre>
<pre class="diffpre insert">+--         yes    #                 no                        |     #</pre>
<pre class="diffpre insert">+--          |     #                  |                        |     #</pre>
<pre class="diffpre insert">+--          |     #                  v                        |     #</pre>
<pre class="diffpre insert">+--          |     #    move every non-player actor that       |     #</pre>
<pre class="diffpre insert">+--          |     #     has &gt; min move energy and has         |     #</pre>
<pre class="diffpre insert">+--          |     #     not elected to skip a move.           |     #</pre>
<pre class="diffpre insert">+--          |     #                  |                        |     #</pre>
<pre class="diffpre insert">+--          |     #                  |                        |     #</pre>
<pre class="diffpre insert">+--          |     #                  v                        |     #</pre>
<pre class="diffpre insert">+--          |     #     add wdEnergyIncrements to all actors--+     #</pre>
<pre class="diffpre insert">+--          |     #           including player's actor              #</pre>
<pre class="diffpre insert">+--          |     #                                                 #</pre>
<pre class="diffpre insert">+--          |     ###################################################</pre>
<pre class="diffpre insert">+--          |</pre>
<pre class="diffpre insert">+--          |</pre>
<pre class="diffpre insert">+--          +---------------&gt; set all actors skipMove = False</pre>
<pre class="diffpre insert">+--                                       |</pre>
<pre class="diffpre insert">+--                                       |</pre>
<pre class="diffpre insert">+--                                       v</pre>
<pre class="diffpre insert">+--                                     (exit)</pre>
<pre class="diffpre insert">+--  </pre>
<pre class="diffpre insert">+--  </pre>
<pre class="diffpre insert">+playerMoving :: Int -&gt; World -&gt; World -&gt; World</pre>
<pre class="diffpre insert">+playerMoving pendingCost pendingWorld oldWorld = </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  let playerAttemptedMoveWorld = </pre>
<pre class="diffpre insert">+        Right oldWorld</pre>
<pre class="diffpre insert">+          &gt;&gt;= checkIfNonMove</pre>
<pre class="diffpre insert">+          &gt;&gt;= checkIfPlayerHasMinEnergy</pre>
<pre class="diffpre insert">+          &gt;&gt;= runPendingIfPlayerHasEnergy</pre>
<pre class="diffpre insert">+          &gt;&gt;= stopIfPlayerCanStillMove</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  in</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  case playerAttemptedMoveWorld of</pre>
<pre class="diffpre insert">+    Left w -&gt; w -- Left means stop </pre>
<pre class="diffpre insert">+    Right w -&gt;  -- Right means continue with other actors</pre>
<pre class="diffpre insert">+      -- Loop, adding energy (wdEnergyincrements) to all actors until the player has enough energy to move</pre>
<pre class="diffpre insert">+      storeSkipTurnEnergy w</pre>
<pre class="diffpre insert">+      &amp; runNonPlayerActorLoop</pre>
<pre class="diffpre insert">+      &amp; restoreSkipTurnEnergy</pre>
<pre class="diffpre insert">+      &amp; disableSkip</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  </pre>
<pre class="diffpre insert">+  where</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    checkIfNonMove w =</pre>
<pre class="diffpre insert">+      -- If the cost is zero/negative then this is not an actual move</pre>
<pre class="diffpre insert">+      --  Apply the pending action and continue</pre>
<pre class="diffpre insert">+      if pendingCost &lt;= 0 &amp;&amp; not (pendingWorld ^. wdPlayer ^. plActor ^. acSkipMove)</pre>
<pre class="diffpre insert">+      then Left pendingWorld</pre>
<pre class="diffpre insert">+      else Right w</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    checkIfPlayerHasMinEnergy w =</pre>
<pre class="diffpre insert">+      if B.get (w ^. wdPlayer ^. plActor ^. acEnergy) &gt;= w ^. wdMinMoveEnergy</pre>
<pre class="diffpre insert">+      then Right w -- continue</pre>
<pre class="diffpre insert">+      else Left w  -- not enough energy to move regardless of move cost</pre>
<pre class="diffpre insert">+    </pre>
<pre class="diffpre insert">+    runPendingIfPlayerHasEnergy w =</pre>
<pre class="diffpre insert">+      if B.get (w ^. wdPlayer ^. plActor ^. acEnergy) &gt;= pendingCost</pre>
<pre class="diffpre insert">+      then</pre>
<pre class="diffpre insert">+        -- perform move and subtract energy</pre>
<pre class="diffpre insert">+        Right (pendingWorld &amp; (wdPlayer . plActor . acEnergy) %~ B.update (subtract pendingCost))</pre>
<pre class="diffpre insert">+      else</pre>
<pre class="diffpre insert">+        -- disallow</pre>
<pre class="diffpre insert">+        Left w</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    stopIfPlayerCanStillMove w =</pre>
<pre class="diffpre insert">+      let</pre>
<pre class="diffpre insert">+        a = w ^. wdPlayer ^. plActor </pre>
<pre class="diffpre insert">+        hasEnergy = B.get (a ^. acEnergy) &gt; a ^. acMoveEnergyCost </pre>
<pre class="diffpre insert">+        skipMove = a ^. acSkipMove </pre>
<pre class="diffpre insert">+      in</pre>
<pre class="diffpre insert">+      if</pre>
<pre class="diffpre insert">+        | skipMove -&gt; Right w -- The player elected to skip a move, continue with others</pre>
<pre class="diffpre insert">+        | hasEnergy -&gt; Left w -- The player has energy, its still their turn</pre>
<pre class="diffpre insert">+        | otherwise -&gt; Right w -- continue</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    runNonPlayerActorLoop w =</pre>
<pre class="diffpre insert">+      if B.get (w ^. wdPlayer ^. plActor ^. acEnergy) &gt;= w ^. wdMinMoveEnergy</pre>
<pre class="diffpre insert">+      then</pre>
<pre class="diffpre insert">+        w -- The player now has enough energy to move, stop loop</pre>
<pre class="diffpre insert">+      else</pre>
<pre class="diffpre insert">+        let</pre>
<pre class="diffpre insert">+          -- Move actors</pre>
<pre class="diffpre insert">+          w' = moveAllNonPlayers w </pre>
<pre class="diffpre insert">+          -- Add energy for next loop</pre>
<pre class="diffpre insert">+          addEnergy _ a = a &amp; acEnergy %~ B.update ((w' ^. wdEnergyIncrements) +)</pre>
<pre class="diffpre insert">+        in</pre>
<pre class="diffpre insert">+        runNonPlayerActorLoop $ updateAllActors w' addEnergy</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    moveAllNonPlayers w =</pre>
<pre class="diffpre insert">+      let</pre>
<pre class="diffpre insert">+        -- Random directions the actors could move in (no diagonal moves)</pre>
<pre class="diffpre insert">+        directions = [(-1,0), (0,-1), (0,1), (1,0)]</pre>
<pre class="diffpre insert">+  </pre>
<pre class="diffpre insert">+        -- Other actors just try to move in random directions</pre>
<pre class="diffpre insert">+        mv aOrig wOrig =</pre>
<pre class="diffpre insert">+          let</pre>
<pre class="diffpre insert">+            -- Pick a random direction to move</pre>
<pre class="diffpre insert">+            (dir, nextStd) = randomElement (aOrig ^. acStdGen) directions </pre>
<pre class="diffpre insert">+            -- Try move, i.e. if there is no wall / actor in the way</pre>
<pre class="diffpre insert">+            w2 = tryMoveActor wOrig aOrig $ fromMaybe (0, 0) dir</pre>
<pre class="diffpre insert">+          in</pre>
<pre class="diffpre insert">+          case w2 of</pre>
<pre class="diffpre insert">+            Nothing -&gt;</pre>
<pre class="diffpre insert">+              -- Unable to move, so skip a turn. This accumulates energy for the next attempt</pre>
<pre class="diffpre insert">+              --  Also update the stdgen for the next time a random number is needed</pre>
<pre class="diffpre insert">+              updateActor wOrig $ aOrig &amp; acSkipMove .~ True</pre>
<pre class="diffpre insert">+                                        &amp; acStdGen .~ nextStd</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+            Just w2' -&gt;</pre>
<pre class="diffpre insert">+              -- The actor moved, use the new world but remember to update the stdgen</pre>
<pre class="diffpre insert">+              updateActorById w2' (aOrig ^. acId) (\a -&gt; a &amp; acStdGen .~ nextStd)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+        -- All actors that have enough energy to move and are not skipping a turn</pre>
<pre class="diffpre insert">+        actorsThatCanMove = filter</pre>
<pre class="diffpre insert">+                            (\a -&gt; B.get (a ^. acEnergy) &gt;= (w ^. wdMinMoveEnergy) &amp;&amp; not (a ^. acSkipMove))</pre>
<pre class="diffpre insert">+                            (Map.elems $ w ^. wdActors)</pre>
<pre class="diffpre insert">+      in</pre>
<pre class="diffpre insert">+      -- Are the any actors that could still move?</pre>
<pre class="diffpre insert">+      if null actorsThatCanMove</pre>
<pre class="diffpre insert">+      then</pre>
<pre class="diffpre insert">+        w -- No one left, done</pre>
<pre class="diffpre insert">+      else</pre>
<pre class="diffpre insert">+        -- Give actors that are able to move a chance to move</pre>
<pre class="diffpre insert">+        foldr mv w actorsThatCanMove</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+      </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    storeSkipTurnEnergy w =</pre>
<pre class="diffpre insert">+      if w ^. wdPlayer ^. plActor ^. acSkipMove</pre>
<pre class="diffpre insert">+      then</pre>
<pre class="diffpre insert">+        -- Store the player's current energy, and set the energy level to zero</pre>
<pre class="diffpre insert">+        -- This lets the actor movement loop run for a full set of turns up to the min energy level</pre>
<pre class="diffpre insert">+        w &amp; (wdPlayer . plPendingEnergy) .~ B.get (w ^. wdPlayer ^. plActor ^. acEnergy)</pre>
<pre class="diffpre insert">+          &amp; (wdPlayer . plActor . acEnergy) %~ B.set 0</pre>
<pre class="diffpre insert">+      else</pre>
<pre class="diffpre insert">+        w</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+      </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    restoreSkipTurnEnergy w =</pre>
<pre class="diffpre insert">+      if w ^. wdPlayer ^. plActor ^. acSkipMove</pre>
<pre class="diffpre insert">+      then</pre>
<pre class="diffpre insert">+        -- Restore and pending energy, up to the player's max energy level</pre>
<pre class="diffpre insert">+        w &amp; (wdPlayer . plActor . acEnergy) %~ B.update ((w ^. wdPlayer ^. plPendingEnergy) +)</pre>
<pre class="diffpre insert">+      else</pre>
<pre class="diffpre insert">+        w</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+      </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    disableSkip w =</pre>
<pre class="diffpre insert">+      updateAllActors w (\_ a -&gt; a &amp; acSkipMove .~ False)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+randomElement :: Rnd.StdGen -&gt; [a] -&gt; (Maybe a, Rnd.StdGen)</pre>
<pre class="diffpre insert">+randomElement g as =</pre>
<pre class="diffpre insert">+  let (i, next) = Rnd.randomR (0, length as - 1) g in</pre>
<pre class="diffpre insert">+  (atMay as i, next)</pre>
<pre class="diffpre insert">+</pre>
</div>
</div>
<h1 id="chapters-1">Chapters</h1>
<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_11.html">prev</a> <a href="2018-04-02-haskell-rogue-like_13.html">next</a></p>


        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          
          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>



        </div>
        <div id="footer">
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
