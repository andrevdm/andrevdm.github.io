<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../../">Home</a>
                <a href="../../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">2018-04-02-haskell-rogue-like_09</a></h1>

            <div class="info">
    Posted on April  2, 2018
    
</div>

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../../">Home</a>
                <a href="../../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">Haskell roguelike - Viewport scrolling</a></h1>

            <div class="info">
    Posted on April  2, 2018
    
</div>

<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_08.html">prev</a> <a href="2018-04-02-haskell-rogue-like_10.html">next</a></p>
<h1 id="viewport-scrolling">Viewport scrolling</h1>
<p>Current the game still allows the player to move off the screen, i.e. out of the viewport. Different roguelikes have different options for dealing with viewport scrolling. Rather than picking a single one I’m going to implement five of them and give the player the option of choosing at runtime which they like best.</p>
<h2 id="styles">Styles</h2>
<p>The five viewport scrolling styles I’m implementing are</p>
<ol type="1">
<li><strong>Scroll</strong>: Scroll the viewport as the player moves. E.g. if you move one position off the screen to the right, the world moves one tile.</li>
<li><strong>Center</strong>: The player is locked in the center of the screen, the world moves around you</li>
<li><strong>Locked</strong>: Like centre but the point that the player is at need not be the centre of the screen.</li>
<li><strong>Snap centre</strong>: Once you move off the screen the viewport is snapped back to the centre.</li>
<li><strong>Border</strong>: There is a set number of tiles border. As you move into this border the screen scrolls.</li>
</ol>
<p>This is what the <strong>center</strong> style looks like</p>
<p><img src="../../images/rogue_09_viewport_center.gif" /></p>
<p>and this is what a 2 tile <strong>border</strong> style looks like</p>
<p><img src="../../images/rogue_09_viewport_border_2.gif" /></p>
<p>Personally I find the <strong>center</strong> style to be too disconcerting. I’ve selected the two tile <strong>border</strong> as the default as I find this the most intuitive. Its advantage over a simple <strong>scroll</strong> style is that if there is tile that you can not move over just off the screen (e.g. a wall) then that tile gets scrolled into the viewport. With <strong>scroll</strong> this does not happen and so you have no idea what is impeding your movement.</p>
<h2 id="code">Code</h2>
<p>Lets start by defining a type for the different styles</p>
<h6 id="viewport_scrollsrcgamecore.hs-72-to-77">09_viewport_scroll/src/GameCore.hs (72 to 77)</h6>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">data</span> <span class="dt">ViewPortStyle</span> <span class="fu">=</span> <span class="dt">ViewPortCentre</span></a>
<a class="sourceLine" id="cb1-2" title="2">                   <span class="fu">|</span> <span class="dt">ViewPortLock</span> <span class="dt">PlayerPos</span></a>
<a class="sourceLine" id="cb1-3" title="3">                   <span class="fu">|</span> <span class="dt">ViewPortScroll</span></a>
<a class="sourceLine" id="cb1-4" title="4">                   <span class="fu">|</span> <span class="dt">ViewPortSnapCentre</span></a>
<a class="sourceLine" id="cb1-5" title="5">                   <span class="fu">|</span> <span class="dt">ViewPortBorder</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-6" title="6">                   <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</a></code></pre></div>
<p>since the player is able to change view port style’s we’ll need an action</p>
<h6 id="viewport_scrollsrcgamecore.hs-67-to-68">09_viewport_scroll/src/GameCore.hs (67 to 68)</h6>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span> <span class="dt">RogueAction</span> <span class="fu">=</span> <span class="dt">ActMovePlayer</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb2-2" title="2">                 <span class="fu">|</span> <span class="dt">ActSetPlayerViewPortStyle</span> <span class="dt">ViewPortStyle</span></a></code></pre></div>
<p><em>plViewPortStyle</em> stores the selected viewport style</p>
<h6 id="viewport_scrollsrcgamecore.hs-34-to-39">09_viewport_scroll/src/GameCore.hs (34 to 39)</h6>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">data</span> <span class="dt">Player</span> <span class="fu">=</span> <span class="dt">Player</span> {<span class="ot"> _plConn ::</span> <span class="fu">!</span><span class="dt">Host.Connection</span></a>
<a class="sourceLine" id="cb3-2" title="2">                     ,<span class="ot"> _plActor ::</span> <span class="fu">!</span><span class="dt">Actor</span></a>
<a class="sourceLine" id="cb3-3" title="3">                     ,<span class="ot"> _plScreenSize ::</span> <span class="fu">!</span>(<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb3-4" title="4">                     ,<span class="ot"> _plWorldTopLeft ::</span> <span class="fu">!</span><span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb3-5" title="5">                     ,<span class="ot"> _plViewPortStyle ::</span> <span class="fu">!</span><span class="dt">ViewPortStyle</span></a>
<a class="sourceLine" id="cb3-6" title="6">                     }</a></code></pre></div>
<p><em>mkPlayer</em> in <em>bootWorld</em> is changed to select the default viewport style</p>
<h6 id="viewport_scrollsrcgameengine.hs-125-to-131">09_viewport_scroll/src/GameEngine.hs (125 to 131)</h6>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1">  mkPlayer <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-2" title="2">    <span class="dt">Player</span> { _plConn <span class="fu">=</span> conn</a>
<a class="sourceLine" id="cb4-3" title="3">           , _plScreenSize <span class="fu">=</span> screenSize</a>
<a class="sourceLine" id="cb4-4" title="4">           , _plWorldTopLeft <span class="fu">=</span> <span class="dt">WorldPos</span> (<span class="dv">0</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-5" title="5">           , _plActor <span class="fu">=</span> mkPlayersActor</a>
<a class="sourceLine" id="cb4-6" title="6">           , _plViewPortStyle <span class="fu">=</span> <span class="dt">ViewPortBorder</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb4-7" title="7">           }</a></code></pre></div>
<h2 id="keys">Keys</h2>
<p>The shortcut keys for viewport style selection must be added. I’ve chosen a chord of <code>shift-v _</code> where <code>V</code> means viewport and <code>_</code> is the style to select.</p>
<h6 id="viewport_scrollsrcgameengine.hs-114-to-118">09_viewport_scroll/src/GameEngine.hs (114 to 118)</h6>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1">  , (<span class="st">&quot;shift+v c&quot;</span>, <span class="st">&quot;Game:ViewPort:Centre&quot;</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">  , (<span class="st">&quot;shift+v s&quot;</span>, <span class="st">&quot;Game:ViewPort:Scroll&quot;</span>)</a>
<a class="sourceLine" id="cb5-3" title="3">  , (<span class="st">&quot;shift+v p&quot;</span>, <span class="st">&quot;Game:ViewPort:Snap&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" title="4">  , (<span class="st">&quot;shift+v b&quot;</span>, <span class="st">&quot;Game:ViewPort:Border&quot;</span>)</a>
<a class="sourceLine" id="cb5-5" title="5">  , (<span class="st">&quot;shift+v l&quot;</span>, <span class="st">&quot;Game:ViewPort:Lock&quot;</span>)</a></code></pre></div>
<p><em>handleKeys</em> is updated to handle the key commands</p>
<h6 id="viewport_scrollsrcgameengine.hs-335-to-339">09_viewport_scroll/src/GameEngine.hs (335 to 339)</h6>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1">  <span class="st">&quot;Game:ViewPort:Centre&quot;</span> <span class="ot">-&gt;</span> [<span class="dt">ActSetPlayerViewPortStyle</span> <span class="dt">ViewPortCentre</span>]</a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="st">&quot;Game:ViewPort:Scroll&quot;</span> <span class="ot">-&gt;</span> [<span class="dt">ActSetPlayerViewPortStyle</span> <span class="dt">ViewPortScroll</span>]</a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="st">&quot;Game:ViewPort:Snap&quot;</span>   <span class="ot">-&gt;</span> [<span class="dt">ActSetPlayerViewPortStyle</span> <span class="dt">ViewPortSnapCentre</span>]</a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="st">&quot;Game:ViewPort:Border&quot;</span> <span class="ot">-&gt;</span> [<span class="dt">ActSetPlayerViewPortStyle</span> <span class="fu">$</span> <span class="dt">ViewPortBorder</span> <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="st">&quot;Game:ViewPort:Lock&quot;</span>   <span class="ot">-&gt;</span> [<span class="dt">ActSetPlayerViewPortStyle</span> <span class="fu">$</span> <span class="dt">ViewPortLock</span> (worldCoordToPlayer topLeft <span class="fu">$</span> actor <span class="fu">^.</span> acWorldPos)]</a></code></pre></div>
<p><em>runAction</em> simply updates the player’s current viewport style</p>
<h6 id="viewport_scrollsrcgameengine.hs-358-to-359">09_viewport_scroll/src/GameEngine.hs (358 to 359)</h6>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1">  <span class="dt">ActSetPlayerViewPortStyle</span> style <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-2" title="2">    world <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plViewPortStyle) <span class="fu">.~</span> style</a></code></pre></div>
<h2 id="the-viewport-logic">The viewport logic</h2>
<p><em>tryMoveActor</em> calls <em>updatePlayerViewport</em> for each move.</p>
<h6 id="viewport_scrollsrcgameengine.hs-411-to-415">09_viewport_scroll/src/GameEngine.hs (411 to 415)</h6>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="co">-- | Update the player's view port</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="ot">updatePlayerViewport ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">World</span></a>
<a class="sourceLine" id="cb8-3" title="3">updatePlayerViewport w <span class="fu">=</span></a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="kw">let</span> p <span class="fu">=</span> w <span class="fu">^.</span> wdPlayer <span class="kw">in</span></a>
<a class="sourceLine" id="cb8-5" title="5">  w <span class="fu">&amp;</span> wdPlayer <span class="fu">.~</span> (p <span class="fu">&amp;</span> plWorldTopLeft <span class="fu">.~</span> calcViewPortTopLeft p)</a></code></pre></div>
<p><em>updatePlayerViewport</em> is just updating the player’s top-left coordinate by calling <em>calcViewPortTopLeft</em>, which is where the core of this logic lives.</p>
<h6 id="viewport_scrollsrcgameengine.hs-420-to-473">09_viewport_scroll/src/GameEngine.hs (420 to 473)</h6>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="ot">calcViewPortTopLeft ::</span> <span class="dt">Player</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb9-2" title="2">calcViewPortTopLeft player <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="kw">let</span> actor <span class="fu">=</span> player <span class="fu">^.</span> plActor <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-4" title="4"></a>
<a class="sourceLine" id="cb9-5" title="5">  <span class="kw">case</span> player <span class="fu">^.</span> plViewPortStyle <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-6" title="6">    <span class="co">-- These two styles put the player in the viewport, so no need to check</span></a>
<a class="sourceLine" id="cb9-7" title="7">    <span class="dt">ViewPortCentre</span> <span class="ot">-&gt;</span> centreOn (player <span class="fu">^.</span> plScreenSize) (actor <span class="fu">^.</span> acWorldPos)</a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="dt">ViewPortLock</span> focus <span class="ot">-&gt;</span> focusOn focus <span class="fu">$</span> actor <span class="fu">^.</span> acWorldPos</a>
<a class="sourceLine" id="cb9-9" title="9"></a>
<a class="sourceLine" id="cb9-10" title="10">    _ <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb9-11" title="11">      <span class="kw">let</span> tl<span class="fu">@</span>(<span class="dt">WorldPos</span> (tX, tY)) <span class="fu">=</span> (player <span class="fu">^.</span> plWorldTopLeft) <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-12" title="12">      <span class="kw">let</span> sz<span class="fu">@</span>(width, height) <span class="fu">=</span> (player <span class="fu">^.</span> plScreenSize) <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-13" title="13">      <span class="kw">let</span> (outX, outY) <span class="fu">=</span> distanceOutOfViewPort sz tl (actor <span class="fu">^.</span> acWorldPos) <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-14" title="14">      </a>
<a class="sourceLine" id="cb9-15" title="15">      <span class="kw">case</span> player <span class="fu">^.</span> plViewPortStyle <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-16" title="16">        <span class="dt">ViewPortSnapCentre</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb9-17" title="17">          <span class="kw">if</span> outX <span class="fu">/=</span> <span class="dv">0</span> <span class="fu">||</span> outY <span class="fu">/=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-18" title="18">          <span class="kw">then</span> centreOn (player <span class="fu">^.</span> plScreenSize) (actor <span class="fu">^.</span> acWorldPos)</a>
<a class="sourceLine" id="cb9-19" title="19">          <span class="kw">else</span> player <span class="fu">^.</span> plWorldTopLeft</a>
<a class="sourceLine" id="cb9-20" title="20"></a>
<a class="sourceLine" id="cb9-21" title="21">        <span class="dt">ViewPortBorder</span> d <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb9-22" title="22">          <span class="kw">let</span> (outX', outY') <span class="fu">=</span> distanceOutOfViewPort</a>
<a class="sourceLine" id="cb9-23" title="23">                                 (width <span class="fu">-</span> d <span class="fu">-</span> d, height <span class="fu">-</span> d <span class="fu">-</span> d)</a>
<a class="sourceLine" id="cb9-24" title="24">                                 (<span class="dt">WorldPos</span> (tX <span class="fu">+</span> d, tY <span class="fu">-</span> d))</a>
<a class="sourceLine" id="cb9-25" title="25">                                 (actor <span class="fu">^.</span> acWorldPos)</a>
<a class="sourceLine" id="cb9-26" title="26">          <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-27" title="27">          <span class="dt">WorldPos</span> (tX <span class="fu">+</span> outX', tY <span class="fu">+</span> outY')</a>
<a class="sourceLine" id="cb9-28" title="28"></a>
<a class="sourceLine" id="cb9-29" title="29">        _ <span class="ot">-&gt;</span> <span class="co">-- default to ViewPortScroll</span></a>
<a class="sourceLine" id="cb9-30" title="30">          <span class="dt">WorldPos</span> (tX <span class="fu">+</span> outX, tY <span class="fu">+</span> outY)</a>
<a class="sourceLine" id="cb9-31" title="31"></a>
<a class="sourceLine" id="cb9-32" title="32">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-33" title="33"><span class="ot">    centreOn ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb9-34" title="34">    centreOn (screenWidth, screenHeight) (<span class="dt">WorldPos</span> (wAtX, wAtY)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-35" title="35">      <span class="kw">let</span> (sMidX, sMidY) <span class="fu">=</span> (screenWidth <span class="ot">`div`</span> <span class="dv">2</span>, screenHeight <span class="ot">`div`</span> <span class="dv">2</span>) <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-36" title="36">      <span class="dt">WorldPos</span> (wAtX <span class="fu">-</span> sMidX, wAtY <span class="fu">+</span> sMidY)</a>
<a class="sourceLine" id="cb9-37" title="37">    </a>
<a class="sourceLine" id="cb9-38" title="38"><span class="ot">    focusOn ::</span> <span class="dt">PlayerPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb9-39" title="39">    focusOn (<span class="dt">PlayerPos</span> (focusX, focusY)) (<span class="dt">WorldPos</span> (atX, atY)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-40" title="40">      <span class="dt">WorldPos</span> (atX <span class="fu">-</span> focusX, atY <span class="fu">+</span> focusY)</a>
<a class="sourceLine" id="cb9-41" title="41">      </a>
<a class="sourceLine" id="cb9-42" title="42">    </a>
<a class="sourceLine" id="cb9-43" title="43"><span class="ot">    distanceOutOfViewPort ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb9-44" title="44">    distanceOutOfViewPort (screenWidth, screenHeight) (<span class="dt">WorldPos</span> (topX, topY)) (<span class="dt">WorldPos</span> (atX, atY)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-45" title="45">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb9-46" title="46">        x <span class="fu">=</span> <span class="kw">if</span> <span class="fu">|</span> atX <span class="fu">&lt;</span>  topX               <span class="ot">-&gt;</span> atX <span class="fu">-</span> topX</a>
<a class="sourceLine" id="cb9-47" title="47">               <span class="fu">|</span> atX <span class="fu">&gt;=</span> topX <span class="fu">+</span> screenWidth <span class="ot">-&gt;</span> atX <span class="fu">-</span> topX <span class="fu">-</span> screenWidth <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-48" title="48">               <span class="fu">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-49" title="49"></a>
<a class="sourceLine" id="cb9-50" title="50">        y <span class="fu">=</span> <span class="kw">if</span> <span class="fu">|</span> atY <span class="fu">&gt;</span>  topY                <span class="ot">-&gt;</span> atY <span class="fu">-</span> topY</a>
<a class="sourceLine" id="cb9-51" title="51">               <span class="fu">|</span> atY <span class="fu">&lt;=</span> topY <span class="fu">-</span> screenHeight <span class="ot">-&gt;</span> atY <span class="fu">-</span> (topY <span class="fu">-</span> screenHeight <span class="fu">+</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb9-52" title="52">               <span class="fu">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-53" title="53">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb9-54" title="54">      (x, y)</a></code></pre></div>
<p>The <strong>lock</strong> and <strong>centre</strong> styles are the simplest. There is no need to check if there player is moving off the screen since the screen is always moved to keep the player at a position. So They just call <em>centreOn</em> or <em>focusOn</em> which calculate a top-left that keeps the player at the desired position.</p>
<h6 id="viewport_scrollsrcgameengine.hs-425-to-428">09_viewport_scroll/src/GameEngine.hs (425 to 428)</h6>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1">  <span class="kw">case</span> player <span class="fu">^.</span> plViewPortStyle <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-2" title="2">    <span class="co">-- These two styles put the player in the viewport, so no need to check</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="dt">ViewPortCentre</span> <span class="ot">-&gt;</span> centreOn (player <span class="fu">^.</span> plScreenSize) (actor <span class="fu">^.</span> acWorldPos)</a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="dt">ViewPortLock</span> focus <span class="ot">-&gt;</span> focusOn focus <span class="fu">$</span> actor <span class="fu">^.</span> acWorldPos</a></code></pre></div>
<h6 id="viewport_scrollsrcgameengine.hs-459-to-466">09_viewport_scroll/src/GameEngine.hs (459 to 466)</h6>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">  centreOn ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb11-2" title="2">  centreOn (screenWidth, screenHeight) (<span class="dt">WorldPos</span> (wAtX, wAtY)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="kw">let</span> (sMidX, sMidY) <span class="fu">=</span> (screenWidth <span class="ot">`div`</span> <span class="dv">2</span>, screenHeight <span class="ot">`div`</span> <span class="dv">2</span>) <span class="kw">in</span></a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="dt">WorldPos</span> (wAtX <span class="fu">-</span> sMidX, wAtY <span class="fu">+</span> sMidY)</a>
<a class="sourceLine" id="cb11-5" title="5">  </a>
<a class="sourceLine" id="cb11-6" title="6"><span class="ot">  focusOn ::</span> <span class="dt">PlayerPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb11-7" title="7">  focusOn (<span class="dt">PlayerPos</span> (focusX, focusY)) (<span class="dt">WorldPos</span> (atX, atY)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="dt">WorldPos</span> (atX <span class="fu">-</span> focusX, atY <span class="fu">+</span> focusY)</a></code></pre></div>
<p><em>scroll</em> is also simple, we just update the top-left by the distance the player has moved out of the view port (see *distanceOutOfViewPort)</p>
<h6 id="viewport_scrollsrcgameengine.hs-453-to-454">09_viewport_scroll/src/GameEngine.hs (453 to 454)</h6>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1">  _ <span class="ot">-&gt;</span> <span class="co">-- default to ViewPortScroll</span></a>
<a class="sourceLine" id="cb12-2" title="2">    <span class="dt">WorldPos</span> (tX <span class="fu">+</span> outX, tY <span class="fu">+</span> outY)</a></code></pre></div>
<p>That leaves <strong>snap</strong> and <strong>border</strong></p>
<h6 id="viewport_scrollsrcgameengine.hs-437-to-449">09_viewport_scroll/src/GameEngine.hs (437 to 449)</h6>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">      <span class="kw">case</span> player <span class="fu">^.</span> plViewPortStyle <span class="kw">of</span></a>
<a class="sourceLine" id="cb13-2" title="2">        <span class="dt">ViewPortSnapCentre</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-3" title="3">          <span class="kw">if</span> outX <span class="fu">/=</span> <span class="dv">0</span> <span class="fu">||</span> outY <span class="fu">/=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-4" title="4">          <span class="kw">then</span> centreOn (player <span class="fu">^.</span> plScreenSize) (actor <span class="fu">^.</span> acWorldPos)</a>
<a class="sourceLine" id="cb13-5" title="5">          <span class="kw">else</span> player <span class="fu">^.</span> plWorldTopLeft</a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7">        <span class="dt">ViewPortBorder</span> d <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb13-8" title="8">          <span class="kw">let</span> (outX', outY') <span class="fu">=</span> distanceOutOfViewPort</a>
<a class="sourceLine" id="cb13-9" title="9">                                 (width <span class="fu">-</span> d <span class="fu">-</span> d, height <span class="fu">-</span> d <span class="fu">-</span> d)</a>
<a class="sourceLine" id="cb13-10" title="10">                                 (<span class="dt">WorldPos</span> (tX <span class="fu">+</span> d, tY <span class="fu">-</span> d))</a>
<a class="sourceLine" id="cb13-11" title="11">                                 (actor <span class="fu">^.</span> acWorldPos)</a>
<a class="sourceLine" id="cb13-12" title="12">          <span class="kw">in</span></a>
<a class="sourceLine" id="cb13-13" title="13">          <span class="dt">WorldPos</span> (tX <span class="fu">+</span> outX', tY <span class="fu">+</span> outY')</a></code></pre></div>
<p><strong>snap</strong> checks if the player is off the screen and if so then snaps the view port to the centre of the screen.</p>
<p><strong>border</strong> calculates if the player is off the border, where the border is the size of the screen minus twice the border size. Then scroll the screen, this means that the screen scrolls before the player gets to the edge.</p>
<p>Finally <em>distanceOutOfView</em> is the helper function that checks how many tiles the player has moved off the screen.</p>
<h6 id="viewport_scrollsrcgameengine.hs-471-to-482">09_viewport_scroll/src/GameEngine.hs (471 to 482)</h6>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">    distanceOutOfViewPort ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> <span class="dt">WorldPos</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb14-2" title="2">    distanceOutOfViewPort (screenWidth, screenHeight) (<span class="dt">WorldPos</span> (topX, topY)) (<span class="dt">WorldPos</span> (atX, atY)) <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-3" title="3">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb14-4" title="4">        x <span class="fu">=</span> <span class="kw">if</span> <span class="fu">|</span> atX <span class="fu">&lt;</span>  topX               <span class="ot">-&gt;</span> atX <span class="fu">-</span> topX</a>
<a class="sourceLine" id="cb14-5" title="5">               <span class="fu">|</span> atX <span class="fu">&gt;=</span> topX <span class="fu">+</span> screenWidth <span class="ot">-&gt;</span> atX <span class="fu">-</span> topX <span class="fu">-</span> screenWidth <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb14-6" title="6">               <span class="fu">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb14-7" title="7"></a>
<a class="sourceLine" id="cb14-8" title="8">        y <span class="fu">=</span> <span class="kw">if</span> <span class="fu">|</span> atY <span class="fu">&gt;</span>  topY                <span class="ot">-&gt;</span> atY <span class="fu">-</span> topY</a>
<a class="sourceLine" id="cb14-9" title="9">               <span class="fu">|</span> atY <span class="fu">&lt;=</span> topY <span class="fu">-</span> screenHeight <span class="ot">-&gt;</span> atY <span class="fu">-</span> (topY <span class="fu">-</span> screenHeight <span class="fu">+</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-10" title="10">               <span class="fu">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb14-11" title="11">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb14-12" title="12">      (x, y)</a></code></pre></div>
<h2 id="teleportation">Teleportation</h2>
<p>You may be tempted to scroll the viewport based on the key pressed. However this usually is a problem later on when you start adding more features to the game. For example teleporters or any other device that moves the player more than a single tile would then require special logic. Its much simpler to simply calculate the viewport from where the player actually was moved to.</p>
<h1 id="chapters">Chapters</h1>
<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_08.html">prev</a> <a href="2018-04-02-haskell-rogue-like_10.html">next</a></p>
<h1 id="changes">Changes</h1>
<div class="wrapper">
<h2 class=".diffh2">
src/GameCore.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b --new-file 08_layers/src/GameCore.hs 09_viewport_scroll/src/GameCore.hs</pre>
<pre class="diffpre delete">--- 08_layers/src/GameCore.hs</pre>
<pre class="diffpre insert">+++ 09_viewport_scroll/src/GameCore.hs</pre>
<pre class="diffpre info">@@ -30,12 +30,15 @@</pre>
<pre class="diffpre context">                    , _acStdGen :: !Rnd.StdGen</pre>
<pre class="diffpre context">                    }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> data Player = Player { _plConn :: !Host.Connection</pre>
<pre class="diffpre context">                      , _plActor :: !Actor</pre>
<pre class="diffpre context">                      , _plScreenSize :: !(Int, Int)</pre>
<pre class="diffpre context">                      , _plWorldTopLeft :: !WorldPos</pre>
<pre class="diffpre insert">+                     , _plViewPortStyle :: !ViewPortStyle</pre>
<pre class="diffpre context">                      }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> data World = World { _wdPlayer :: !Player</pre>
<pre class="diffpre context">                    , _wdConfig :: !Config</pre>
<pre class="diffpre context">                    , _wdMap :: !(Map WorldPos Entity)</pre>
<pre class="diffpre info">@@ -60,7 +63,19 @@</pre>
<pre class="diffpre context"> newtype WorldPos = WorldPos (Int, Int) deriving (Show, Eq, Ord)</pre>
<pre class="diffpre context"> newtype PlayerPos = PlayerPos (Int, Int) deriving (Show, Eq, Ord)</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-newtype RogueAction = ActMovePlayer (Int, Int)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+data RogueAction = ActMovePlayer (Int, Int)</pre>
<pre class="diffpre insert">+                 | ActSetPlayerViewPortStyle ViewPortStyle</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+data ViewPortStyle = ViewPortCentre</pre>
<pre class="diffpre insert">+                   | ViewPortLock PlayerPos</pre>
<pre class="diffpre insert">+                   | ViewPortScroll</pre>
<pre class="diffpre insert">+                   | ViewPortSnapCentre</pre>
<pre class="diffpre insert">+                   | ViewPortBorder Int</pre>
<pre class="diffpre insert">+                   deriving (Show, Eq)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data UiMessage = UiMessage { umCmd :: !Text</pre>
</div>
<h2 class=".diffh2">
src/GameEngine.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b --new-file 08_layers/src/GameEngine.hs 09_viewport_scroll/src/GameEngine.hs</pre>
<pre class="diffpre delete">--- 08_layers/src/GameEngine.hs</pre>
<pre class="diffpre insert">+++ 09_viewport_scroll/src/GameEngine.hs</pre>
<pre class="diffpre info">@@ -109,17 +109,28 @@</pre>
<pre class="diffpre context">                                        , ("end"     , "Move:down-left")</pre>
<pre class="diffpre context">                                        , ("b"       , "Move:down-left")</pre>
<pre class="diffpre context">                                        , ("pagedown", "Move:down-right")</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+                                       , ("shift+v c", "Game:ViewPort:Centre")</pre>
<pre class="diffpre insert">+                                       , ("shift+v s", "Game:ViewPort:Scroll")</pre>
<pre class="diffpre insert">+                                       , ("shift+v p", "Game:ViewPort:Snap")</pre>
<pre class="diffpre insert">+                                       , ("shift+v b", "Game:ViewPort:Border")</pre>
<pre class="diffpre insert">+                                       , ("shift+v l", "Game:ViewPort:Lock")</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">                                        ]</pre>
<pre class="diffpre delete">-             , _cfgMinMaxBounds = (0, 30, -30, 0)</pre>
<pre class="diffpre insert">+             , _cfgMinMaxBounds = (-300, 300, -300, 300)</pre>
<pre class="diffpre context">              }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">     mkPlayer =</pre>
<pre class="diffpre context">       Player { _plConn = conn</pre>
<pre class="diffpre context">              , _plScreenSize = screenSize</pre>
<pre class="diffpre context">              , _plWorldTopLeft = WorldPos (0, 0)</pre>
<pre class="diffpre context">              , _plActor = mkPlayersActor</pre>
<pre class="diffpre insert">+             , _plViewPortStyle = ViewPortBorder 2</pre>
<pre class="diffpre context">              }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">     mkPlayersActor =</pre>
<pre class="diffpre context">       Actor { _acId = Aid "player"</pre>
<pre class="diffpre context">             , _acClass = ClassPlayer</pre>
<pre class="diffpre info">@@ -151,7 +162,7 @@</pre>
<pre class="diffpre context">       </pre>
<pre class="diffpre context">     "key" -&gt; do</pre>
<pre class="diffpre context">       -- Handle the key press</pre>
<pre class="diffpre delete">-      atomically $ modifyTVar' worldV (\w -&gt; runActions w $ handleKey cmdData)</pre>
<pre class="diffpre insert">+      atomically $ modifyTVar' worldV (\w -&gt; runActions w $ handleKey w cmdData)</pre>
<pre class="diffpre context">       -- Get the updated world</pre>
<pre class="diffpre context">       w2 &lt;- atomically $ readTVar worldV</pre>
<pre class="diffpre context">       -- Draw</pre>
<pre class="diffpre info">@@ -310,8 +316,11 @@</pre>
<pre class="diffpre context">   world ^. wdPlayer ^. plActor : Map.elems (world ^. wdActors)</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-handleKey :: [Text] -&gt; [RogueAction]</pre>
<pre class="diffpre delete">-handleKey (cmd:_) = </pre>
<pre class="diffpre insert">+handleKey :: World -&gt; [Text] -&gt; [RogueAction]</pre>
<pre class="diffpre insert">+handleKey world (cmd:_) = </pre>
<pre class="diffpre insert">+  let actor = world ^. wdPlayer ^. plActor in</pre>
<pre class="diffpre insert">+  let topLeft = world ^. wdPlayer ^. plWorldTopLeft in</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">   case cmd of</pre>
<pre class="diffpre context">     "Move:up"         -&gt; [ActMovePlayer ( 0,  1)]</pre>
<pre class="diffpre context">     "Move:down"       -&gt; [ActMovePlayer ( 0, -1)]</pre>
<pre class="diffpre info">@@ -321,8 +330,17 @@</pre>
<pre class="diffpre context">     "Move:up-left"    -&gt; [ActMovePlayer (-1,  1)]</pre>
<pre class="diffpre context">     "Move:down-right" -&gt; [ActMovePlayer ( 1, -1)]</pre>
<pre class="diffpre context">     "Move:down-left"  -&gt; [ActMovePlayer (-1, -1)]</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    "Game:ViewPort:Centre" -&gt; [ActSetPlayerViewPortStyle ViewPortCentre]</pre>
<pre class="diffpre insert">+    "Game:ViewPort:Scroll" -&gt; [ActSetPlayerViewPortStyle ViewPortScroll]</pre>
<pre class="diffpre insert">+    "Game:ViewPort:Snap"   -&gt; [ActSetPlayerViewPortStyle ViewPortSnapCentre]</pre>
<pre class="diffpre insert">+    "Game:ViewPort:Border" -&gt; [ActSetPlayerViewPortStyle $ ViewPortBorder 2]</pre>
<pre class="diffpre insert">+    "Game:ViewPort:Lock"   -&gt; [ActSetPlayerViewPortStyle $ ViewPortLock (worldCoordToPlayer topLeft $ actor ^. acWorldPos)]</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">     _                 -&gt; []</pre>
<pre class="diffpre delete">-handleKey _ = []</pre>
<pre class="diffpre insert">+handleKey _ _ = []</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> runActions :: World -&gt; [RogueAction] -&gt; World</pre>
<pre class="diffpre info">@@ -337,6 +355,11 @@</pre>
<pre class="diffpre context">       fromMaybe world $ tryMoveActor world (world ^. wdPlayer ^. plActor) move</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+    ActSetPlayerViewPortStyle style -&gt;</pre>
<pre class="diffpre insert">+      world &amp; (wdPlayer . plViewPortStyle) .~ style</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> tryMoveActor :: World -&gt; Actor -&gt; (Int, Int) -&gt; Maybe World</pre>
<pre class="diffpre context"> tryMoveActor world actor (dx, dy) =</pre>
<pre class="diffpre context">   let</pre>
<pre class="diffpre info">@@ -371,7 +394,7 @@</pre>
<pre class="diffpre context">       if canMove</pre>
<pre class="diffpre context">       then</pre>
<pre class="diffpre context">         let movedActor = actor &amp; acWorldPos .~ tryWorldTo' in</pre>
<pre class="diffpre delete">-        Just $ updateActor world movedActor</pre>
<pre class="diffpre insert">+        Just . updatePlayerViewport $ updateActor world movedActor</pre>
<pre class="diffpre context">       else</pre>
<pre class="diffpre context">         Nothing</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre info">@@ -382,3 +405,80 @@</pre>
<pre class="diffpre context">   if w ^. wdPlayer ^. plActor ^. acId == (actor ^. acId)</pre>
<pre class="diffpre context">   then w &amp; (wdPlayer . plActor) .~ actor                         -- update the player's actor</pre>
<pre class="diffpre context">   else w &amp; wdActors %~ Map.adjust (const actor) (actor ^. acId)  -- update other actor, nop if aid not found</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+-- | Update the player's view port</pre>
<pre class="diffpre insert">+updatePlayerViewport :: World -&gt; World</pre>
<pre class="diffpre insert">+updatePlayerViewport w =</pre>
<pre class="diffpre insert">+  let p = w ^. wdPlayer in</pre>
<pre class="diffpre insert">+  w &amp; wdPlayer .~ (p &amp; plWorldTopLeft .~ calcViewPortTopLeft p)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+calcViewPortTopLeft :: Player -&gt; WorldPos</pre>
<pre class="diffpre insert">+calcViewPortTopLeft player =</pre>
<pre class="diffpre insert">+  let actor = player ^. plActor in</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  case player ^. plViewPortStyle of</pre>
<pre class="diffpre insert">+    -- These two styles put the player in the viewport, so no need to check</pre>
<pre class="diffpre insert">+    ViewPortCentre -&gt; centreOn (player ^. plScreenSize) (actor ^. acWorldPos)</pre>
<pre class="diffpre insert">+    ViewPortLock focus -&gt; focusOn focus $ actor ^. acWorldPos</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    _ -&gt; </pre>
<pre class="diffpre insert">+      let tl@(WorldPos (tX, tY)) = (player ^. plWorldTopLeft) in</pre>
<pre class="diffpre insert">+      let sz@(width, height) = (player ^. plScreenSize) in</pre>
<pre class="diffpre insert">+      let (outX, outY) = distanceOutOfViewPort sz tl (actor ^. acWorldPos) in</pre>
<pre class="diffpre insert">+      </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+      case player ^. plViewPortStyle of</pre>
<pre class="diffpre insert">+        ViewPortSnapCentre -&gt;</pre>
<pre class="diffpre insert">+          if outX /= 0 || outY /= 0</pre>
<pre class="diffpre insert">+          then centreOn (player ^. plScreenSize) (actor ^. acWorldPos)</pre>
<pre class="diffpre insert">+          else player ^. plWorldTopLeft</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+        ViewPortBorder d -&gt;</pre>
<pre class="diffpre insert">+          let (outX', outY') = distanceOutOfViewPort</pre>
<pre class="diffpre insert">+                                 (width - d - d, height - d - d)</pre>
<pre class="diffpre insert">+                                 (WorldPos (tX + d, tY - d))</pre>
<pre class="diffpre insert">+                                 (actor ^. acWorldPos)</pre>
<pre class="diffpre insert">+          in</pre>
<pre class="diffpre insert">+          WorldPos (tX + outX', tY + outY')</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+        _ -&gt; -- default to ViewPortScroll</pre>
<pre class="diffpre insert">+          WorldPos (tX + outX, tY + outY)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  where</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    centreOn :: (Int, Int) -&gt; WorldPos -&gt; WorldPos</pre>
<pre class="diffpre insert">+    centreOn (screenWidth, screenHeight) (WorldPos (wAtX, wAtY)) =</pre>
<pre class="diffpre insert">+      let (sMidX, sMidY) = (screenWidth `div` 2, screenHeight `div` 2) in</pre>
<pre class="diffpre insert">+      WorldPos (wAtX - sMidX, wAtY + sMidY)</pre>
<pre class="diffpre insert">+    </pre>
<pre class="diffpre insert">+    focusOn :: PlayerPos -&gt; WorldPos -&gt; WorldPos</pre>
<pre class="diffpre insert">+    focusOn (PlayerPos (focusX, focusY)) (WorldPos (atX, atY)) =</pre>
<pre class="diffpre insert">+      WorldPos (atX - focusX, atY + focusY)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+      </pre>
<pre class="diffpre insert">+    </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    distanceOutOfViewPort :: (Int, Int) -&gt; WorldPos -&gt; WorldPos -&gt; (Int, Int)</pre>
<pre class="diffpre insert">+    distanceOutOfViewPort (screenWidth, screenHeight) (WorldPos (topX, topY)) (WorldPos (atX, atY)) =</pre>
<pre class="diffpre insert">+      let</pre>
<pre class="diffpre insert">+        x = if | atX &lt;  topX               -&gt; atX - topX</pre>
<pre class="diffpre insert">+               | atX &gt;= topX + screenWidth -&gt; atX - topX - screenWidth + 1</pre>
<pre class="diffpre insert">+               | otherwise -&gt; 0</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+        y = if | atY &gt;  topY                -&gt; atY - topY</pre>
<pre class="diffpre insert">+               | atY &lt;= topY - screenHeight -&gt; atY - (topY - screenHeight + 1)</pre>
<pre class="diffpre insert">+               | otherwise -&gt; 0</pre>
<pre class="diffpre insert">+      in</pre>
<pre class="diffpre insert">+      (x, y)</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
</div>
</div>
<h1 id="chapters-1">Chapters</h1>
<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_08.html">prev</a> <a href="2018-04-02-haskell-rogue-like_10.html">next</a></p>


        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          
          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>



        </div>
        <div id="footer">
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
