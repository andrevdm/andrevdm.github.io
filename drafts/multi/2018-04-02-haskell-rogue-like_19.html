<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Andre's Blog</title>
        <link rel="stylesheet" type="text/css" href="../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../">Blog</a>
            </div>
            <div id="navigation">
                <a href="../../">Home</a>
                <a href="../../contact.html">Contact</a>
                <!-- <a href="/about.html">About</a> -->
            </div>
        </div>

        <div id="content">
            <h1><a href="#top">Haskell roguelike - Story</a></h1>

            <div class="info">
    Posted on April  2, 2018
    
</div>

<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_18.html">prev</a> <a href="2018-04-02-haskell-rogue-like_20.html">next</a></p>
<h1 id="plot">Plot</h1>
<p>So far the game is an open world with free play. Very often however you are going to want a bit more structure. This can range from the trivial “you need an x to do a y” to full blow sub-plots. In this chapter we’ll add the former, the player needs to pick up the key to unlock the door to the second level. To make things a bit more interesting lets also add two potions, one to disable darkness and one to enable it again.</p>
<h6 id="storysrcentitytype.hs-8-to-21">19_story/src/EntityType.hs (8 to 21)</h6>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">data</span> <span class="dt">EntityType</span> <span class="fu">=</span> <span class="dt">Blank</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">                <span class="fu">|</span> <span class="dt">Door</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">                <span class="fu">|</span> <span class="dt">DoorClosed</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">                <span class="fu">|</span> <span class="dt">Wall</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">                <span class="fu">|</span> <span class="dt">Player</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">                <span class="fu">|</span> <span class="dt">Bug</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">                <span class="fu">|</span> <span class="dt">Snake</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">                <span class="fu">|</span> <span class="dt">Dark</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">                <span class="fu">|</span> <span class="dt">Stairs</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">                <span class="fu">|</span> <span class="dt">PotionDark</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">                <span class="fu">|</span> <span class="dt">PotionLight</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">                <span class="fu">|</span> <span class="dt">Key</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">                <span class="fu">|</span> <span class="dt">Unknown</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">                <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</a></code></pre></div>
<h6 id="storysrcentities.hs-28-to-30">19_story/src/Entities.hs (28 to 30)</h6>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1">  , (<span class="dt">E.PotionDark</span> , (<span class="dv">16</span>, <span class="dv">46</span>), <span class="dt">Just</span> <span class="st">&quot;pd&quot;</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  , (<span class="dt">E.PotionLight</span>, ( <span class="dv">8</span>, <span class="dv">46</span>), <span class="dt">Just</span> <span class="st">&quot;pl&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  , (<span class="dt">E.Key</span>        , (<span class="dv">54</span>, <span class="dv">45</span>), <span class="dt">Just</span> <span class="st">&quot;ke&quot;</span>)</a></code></pre></div>
<p><img src="../../images/rogue_19_story.png" /></p>
<h1 id="story-handler">Story handler</h1>
<p>A story handler is the function that decides which actions to perform when an even occurs.</p>
<h6 id="storysrcgamecore.hs-110-to-110">19_story/src/GameCore.hs (110 to 110)</h6>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">type</span> <span class="dt">StoryHandler</span> <span class="fu">=</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">RogueEvent</span> <span class="ot">-&gt;</span> [<span class="dt">RogueAction</span>]</a></code></pre></div>
<h2 id="events">Events</h2>
<p>We don’t yet have an event type so lets add one There is only one event type so far, <em>EvtMove</em>. It has</p>
<ol type="1">
<li>The actors at the destination</li>
<li>The entity type at the destination (non-actor)</li>
<li>The world</li>
<li>The moving actor</li>
</ol>
<h6 id="storysrcgamecore.hs-131-to-131">19_story/src/GameCore.hs (131 to 131)</h6>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">data</span> <span class="dt">RogueEvent</span> <span class="fu">=</span> <span class="dt">EvtMove</span> [<span class="dt">Actor</span>] (<span class="dt">Maybe</span> <span class="dt">E.EntityType</span>) <span class="dt">WorldPos</span> <span class="dt">Actor</span></a></code></pre></div>
<h2 id="level">Level</h2>
<p>Each level has its own story handlers to control their plot. Since the story handler is now responding to the move events, the level no longer has a <em>lvlTryMove</em> property.</p>
<h6 id="storysrcgamecore.hs-97-to-101">19_story/src/GameCore.hs (97 to 101)</h6>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Level</span> <span class="fu">=</span> <span class="dt">Level</span> {<span class="ot"> _lvlName ::</span> <span class="fu">!</span><span class="dt">Text</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                   ,<span class="ot"> _lvlBoot ::</span> <span class="fu">!</span>(<span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">World</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">                   ,<span class="ot"> _lvlMapText ::</span> <span class="fu">!</span><span class="dt">Text</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">                   ,<span class="ot"> _lvlStoryHandler ::</span> <span class="fu">!</span><span class="dt">StoryHandler</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">                   }</a></code></pre></div>
<h1 id="properties">Properties</h1>
<p>As the story progresses we are going to need somewhere to store the state of the story. Fortunately back in <a href="2018-04-02-haskell-rogue-like_16.html">chapter 16</a> we added <em>acProps</em> to the actor.</p>
<p>The story handler needs a way to set these properties. We already have <em>ActTogglePlayerProp</em> lets add two more actions to manipulate an actor’s properties</p>
<h6 id="storysrcgamecore.hs-118-to-119">19_story/src/GameCore.hs (118 to 119)</h6>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1">  <span class="fu">|</span> <span class="dt">ActClearPlayerProp</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="fu">|</span> <span class="dt">ActSetPlayerProp</span> <span class="dt">Text</span> <span class="dt">Text</span></a></code></pre></div>
<p>The changes to <em>runAction</em> to handle these actions are quite simple map manipulations.</p>
<h6 id="storysrcgameengine.hs-435-to-439">19_story/src/GameEngine.hs (435 to 439)</h6>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1">    <span class="dt">ActSetPlayerProp</span> prop valEnabled <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">      world <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plActor <span class="fu">.</span> acProps) <span class="fu">%~</span> Map.insert prop valEnabled</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="dt">ActClearPlayerProp</span> prop <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">      world <span class="fu">&amp;</span> (wdPlayer <span class="fu">.</span> plActor <span class="fu">.</span> acProps) <span class="fu">%~</span> Map.delete prop</a></code></pre></div>
<h1 id="changing-entities">Changing entities</h1>
<p>Picking up the key will change the closed door to an open door. We need to add one action to replace entities and one to remove them (picking up the key).</p>
<h6 id="storysrcgamecore.hs-126-to-127">19_story/src/GameCore.hs (126 to 127)</h6>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1">  <span class="fu">|</span> <span class="dt">ActRemoveEntity</span> <span class="dt">E.EntityType</span> <span class="dt">WorldPos</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="fu">|</span> <span class="dt">ActReplaceEntity</span> <span class="dt">E.EntityType</span> <span class="dt">WorldPos</span> <span class="dt">Entity</span></a></code></pre></div>
<p>These two actions are also implemented as map manipulations. Both check that the entity being operated on (deleted / replaced) is the expected entity. If not, the operation is ignored.</p>
<h6 id="storysrcgameengine.hs-464-to-468">19_story/src/GameEngine.hs (464 to 468)</h6>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1">    <span class="dt">ActRemoveEntity</span> existingType atWorldPos <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">      world <span class="fu">&amp;</span> wdMap <span class="fu">%~</span> Map.alter (deleteMapEntity existingType) atWorldPos</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    <span class="dt">ActReplaceEntity</span> existingType atWorldPos newEntity <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">      world <span class="fu">&amp;</span> wdMap <span class="fu">%~</span> Map.alter (alterMapEntity existingType newEntity) atWorldPos</a></code></pre></div>
<h6 id="storysrcgameengine.hs-476-to-482">19_story/src/GameEngine.hs (476 to 482)</h6>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="ot">    alterMapEntity ::</span> <span class="dt">E.EntityType</span> <span class="ot">-&gt;</span> <span class="dt">Entity</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Entity</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Entity</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    alterMapEntity _ new <span class="dt">Nothing</span> <span class="fu">=</span> <span class="dt">Just</span> new</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    alterMapEntity oldType new (<span class="dt">Just</span> oldEntity) <span class="fu">=</span> <span class="kw">if</span> oldType <span class="fu">==</span> (oldEntity <span class="fu">^.</span> enType) <span class="kw">then</span> <span class="dt">Just</span> new <span class="kw">else</span> <span class="dt">Just</span> oldEntity</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="ot">    deleteMapEntity ::</span> <span class="dt">E.EntityType</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Entity</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Entity</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    deleteMapEntity _ <span class="dt">Nothing</span> <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    deleteMapEntity oldType (<span class="dt">Just</span> oldEntity) <span class="fu">=</span> <span class="kw">if</span> oldType <span class="fu">==</span> (oldEntity <span class="fu">^.</span> enType) <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> oldEntity</a></code></pre></div>
<h1 id="running-a-story">Running a story</h1>
<p>Back in the <a href="2018-04-02-haskell-rogue-like_13.html">utility AI chapter</a> I explained why I decided again using a state machine for the AI. For a simple plot however a state machine is perfect. This is because there are a limited number of simple transitions.</p>
<p>Originally I started with a state machine module but that turned out to be overkill. What I ended up with was that each level has a current story handler (the current state its at) and each of these handlers can change the level’s story handler, i.e. perform a transitions</p>
<p>You already saw the level’s <em>lvlStoryHandler</em> above: <code>_lvlStoryHandler :: !StoryHandler</code></p>
<h2 id="change-story-handler-action">Change story handler action</h2>
<p>Lets add the action to change the current story handler</p>
<h6 id="storysrcgamecore.hs-123-to-123">19_story/src/GameCore.hs (123 to 123)</h6>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1">  <span class="fu">|</span> <span class="dt">ActSetStoryHandler</span> <span class="dt">StoryHandler</span></a></code></pre></div>
<p><em>runAction</em> simply changes the current level’s story handler in response to this action.</p>
<h6 id="storysrcgameengine.hs-459-to-460">19_story/src/GameEngine.hs (459 to 460)</h6>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1">  <span class="dt">ActSetStoryHandler</span> h <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    world <span class="fu">&amp;</span> (wdLevel <span class="fu">.</span> lvlStoryHandler) <span class="fu">.~</span> h</a></code></pre></div>
<h2 id="sending-events-to-the-story-handler">Sending events to the story handler</h2>
<p>GameEngine’s <em>tryMoveActor</em> must now create a <em>RogueEvent</em> and send it to the level’s story handler. This is not very different from the old code but means that new events can easily be added.</p>
<h6 id="storysrcgameengine.hs-511-to-516">19_story/src/GameEngine.hs (511 to 516)</h6>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1">     <span class="co">-- Create move event</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">     evt <span class="fu">=</span> <span class="dt">EvtMove</span> destActors destEntityType tryWorldTo' actor</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">     <span class="co">-- Run even to get actions</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">     actions <span class="fu">=</span> (world <span class="fu">^.</span> wdLevel <span class="fu">^.</span> lvlStoryHandler) world evt </a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  <span class="kw">in</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  <span class="dt">Just</span> <span class="fu">$</span> runActions world actions </a></code></pre></div>
<h2 id="levels-story-handler">Level’s story handler</h2>
<p>When a level is created the default story handler must be set. For level one the story starts waiting for the player to pickup the key.</p>
<h6 id="storysrclevelslevel01.hs-20-to-26">19_story/src/Levels/Level01.hs (20 to 26)</h6>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="ot">mkLevel ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Level</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">mkLevel mapText <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="dt">Level</span> { _lvlName <span class="fu">=</span> <span class="st">&quot;L01&quot;</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">        , _lvlBoot <span class="fu">=</span> bootLevel </a>
<a class="sourceLine" id="cb14-5" data-line-number="5">        , _lvlMapText <span class="fu">=</span> mapText</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">        , _lvlStoryHandler <span class="fu">=</span> storyWaitingForKey</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">        }</a></code></pre></div>
<h2 id="shared-logic">Shared logic</h2>
<p>Once you start designing your story logic (state machine) you will quickly realise that most of the story handlers have to deal with the same event the same way. E.g. stepping on a blank tile is the same for all the handlers. I’m managing this by having a shared handler (<em>storyCommon</em>) that each of the other handlers can call if they are not handling the event. This means that story handlers can override whatever default behavior they need to.</p>
<h3 id="storycommon">storyCommon</h3>
<p><em>storyCommon</em> handles basic collisions. It also handles the logic of the player stepping on one of the two potions.</p>
<h6 id="storysrclevelslevel01.hs-73-to-94">19_story/src/Levels/Level01.hs (73 to 94)</h6>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="ot">storyCommon ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">RogueEvent</span> <span class="ot">-&gt;</span> [<span class="dt">RogueAction</span>]</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">storyCommon world evt <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="kw">case</span> evt <span class="kw">of</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    <span class="dt">EvtMove</span> destActors destEntityType posTo movingActor <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">      <span class="kw">let</span> isPlayer <span class="fu">=</span> isPlayerMoving world movingActor <span class="kw">in</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">      <span class="kw">case</span> (isPlayer, destActors, destEntityType) <span class="kw">of</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">        (_, [], <span class="dt">Just</span> <span class="dt">E.Blank</span>) <span class="ot">-&gt;</span> [<span class="dt">ActMoveActor</span> movingActor posTo]</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">        (_, [], <span class="dt">Just</span> <span class="dt">E.Door</span>) <span class="ot">-&gt;</span> [<span class="dt">ActMoveActor</span> movingActor posTo]</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">        (_, [], <span class="dt">Nothing</span>) <span class="ot">-&gt;</span> [<span class="dt">ActMoveActor</span> movingActor posTo]</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">        <span class="co">-- Only the player can pickup potions. Set lights on</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12">        (<span class="dt">True</span>, [], <span class="dt">Just</span> <span class="dt">E.PotionLight</span>) <span class="ot">-&gt;</span> [ <span class="dt">ActMoveActor</span> movingActor posTo</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">                                          , <span class="dt">ActSetPlayerProp</span> <span class="st">&quot;debug:light&quot;</span> <span class="st">&quot;on&quot;</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14">                                          , <span class="dt">ActRemoveEntity</span> <span class="dt">E.PotionLight</span> posTo</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">                                          ]</a>
<a class="sourceLine" id="cb15-16" data-line-number="16"></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">        <span class="co">-- Only the player can pickup potions. Set lights off</span></a>
<a class="sourceLine" id="cb15-18" data-line-number="18">        (<span class="dt">True</span>, [], <span class="dt">Just</span> <span class="dt">E.PotionDark</span>) <span class="ot">-&gt;</span> [ <span class="dt">ActMoveActor</span> movingActor posTo</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">                                         , <span class="dt">ActClearPlayerProp</span> <span class="st">&quot;debug:light&quot;</span></a>
<a class="sourceLine" id="cb15-20" data-line-number="20">                                         , <span class="dt">ActRemoveEntity</span> <span class="dt">E.PotionDark</span> posTo</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">                                         ]</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">        _ <span class="ot">-&gt;</span> []</a></code></pre></div>
<ul>
<li>The code checks if its the player that is moving</li>
<li>Stepping on a door, blank space or nothing is allowed</li>
<li>Stepping on a potion will
<ol type="1">
<li>Let the player move</li>
<li>Set the appropriate property to toggle darkness</li>
<li>Remove the potion, as it has been picked up</li>
</ol></li>
</ul>
<h6 id="storysrclevelslevel01.hs-141-to-143">19_story/src/Levels/Level01.hs (141 to 143)</h6>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="ot">isPlayerMoving ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">Actor</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">isPlayerMoving w a <span class="fu">=</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  w <span class="fu">^.</span> wdPlayer <span class="fu">^.</span> plActor <span class="fu">^.</span> acId <span class="fu">==</span> a <span class="fu">^.</span> acId</a></code></pre></div>
<h3 id="storywaitingforkey">storyWaitingForKey</h3>
<h6 id="storysrclevelslevel01.hs-99-to-124">19_story/src/Levels/Level01.hs (99 to 124)</h6>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="ot">storyWaitingForKey ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">RogueEvent</span> <span class="ot">-&gt;</span> [<span class="dt">RogueAction</span>]</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">storyWaitingForKey world evt <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  <span class="kw">case</span> evt <span class="kw">of</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">    <span class="dt">EvtMove</span> destActors destEntityType posTo movingActor <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">      <span class="kw">let</span> isPlayer <span class="fu">=</span> isPlayerMoving world movingActor <span class="kw">in</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">      <span class="kw">case</span> (isPlayer, destActors, destEntityType) <span class="kw">of</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8">        <span class="co">-- Player picked up the key</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">        (<span class="dt">True</span>, [], <span class="dt">Just</span> <span class="dt">E.Key</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">          [ <span class="dt">ActMoveActor</span> movingActor posTo</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">          , <span class="dt">ActSetStoryHandler</span> storyDoorOpen</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">          , <span class="dt">ActRemoveEntity</span> <span class="dt">E.Key</span> posTo</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">          ] <span class="fu">&lt;&gt;</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14">          <span class="co">-- Replace all closed doors with open ones</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">          ((\closedDoorAt <span class="ot">-&gt;</span> <span class="dt">ActReplaceEntity</span> <span class="dt">E.DoorClosed</span> closedDoorAt <span class="fu">$</span> E.getEntity <span class="dt">E.Door</span>) <span class="fu">&lt;$&gt;</span> findPos <span class="dt">E.DoorClosed</span>)</a>
<a class="sourceLine" id="cb17-16" data-line-number="16">                 </a>
<a class="sourceLine" id="cb17-17" data-line-number="17">        _ <span class="ot">-&gt;</span> storyCommon world evt</a>
<a class="sourceLine" id="cb17-18" data-line-number="18"></a>
<a class="sourceLine" id="cb17-19" data-line-number="19">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb17-20" data-line-number="20"><span class="ot">    findPos ::</span> <span class="dt">E.EntityType</span> <span class="ot">-&gt;</span> [<span class="dt">WorldPos</span>]</a>
<a class="sourceLine" id="cb17-21" data-line-number="21">    findPos et <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-22" data-line-number="22">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb17-23" data-line-number="23">        es <span class="fu">=</span> Map.toList <span class="fu">$</span> world <span class="fu">^.</span> wdMap</a>
<a class="sourceLine" id="cb17-24" data-line-number="24">        found <span class="fu">=</span> filter (\(_, e) <span class="ot">-&gt;</span> e <span class="fu">^.</span> enType <span class="fu">==</span> et) es</a>
<a class="sourceLine" id="cb17-25" data-line-number="25">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb17-26" data-line-number="26">      fst <span class="fu">&lt;$&gt;</span> found</a></code></pre></div>
<ul>
<li>If the player steps on a key.</li>
<li>Then
<ol type="1">
<li>Allow the move</li>
<li>Change the story handler to <em>storyDoorOpen</em> (state transition)</li>
<li>Remove the entity (pick it up)</li>
<li>Change all closed doors to open ones</li>
</ol></li>
<li>Else
<ol type="1">
<li>Run <em>storyCommon</em></li>
</ol></li>
</ul>
<h3 id="storydooropen">storyDoorOpen</h3>
<h6 id="storysrclevelslevel01.hs-129-to-136">19_story/src/Levels/Level01.hs (129 to 136)</h6>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="ot">storyDoorOpen ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">RogueEvent</span> <span class="ot">-&gt;</span> [<span class="dt">RogueAction</span>]</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">storyDoorOpen world evt <span class="fu">=</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">  <span class="kw">case</span> evt <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4">    <span class="dt">EvtMove</span> destActors destEntityType posTo movingActor <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">      <span class="kw">case</span> (destActors, destEntityType) <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">        ([], <span class="dt">Just</span> <span class="dt">E.Key</span>) <span class="ot">-&gt;</span> [<span class="dt">ActMoveActor</span> movingActor posTo]</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">        (_, <span class="dt">Just</span> <span class="dt">E.Stairs</span>) <span class="ot">-&gt;</span> [<span class="dt">ActGotoLevel</span> <span class="dt">Levels02</span>]</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">        _ <span class="ot">-&gt;</span> storyCommon world evt</a></code></pre></div>
<ul>
<li>Picking up keys does nothing anymore, the door is already open</li>
<li>If the player steps on the stairs then go to level two</li>
<li>Otherwise run <em>storyCommon</em></li>
</ul>
<h1 id="multiple-levels-with-plot">Multiple levels with plot</h1>
<p>With these changes the game now supports different levels each with a different plot. Not bad at all</p>
<h1 id="chapters">Chapters</h1>
<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_18.html">prev</a> <a href="2018-04-02-haskell-rogue-like_20.html">next</a></p>
<h1 id="changes">Changes</h1>
<div class="wrapper">
<h2 class=".diffh2">
src/Entities.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b -r --new-file 18_multi_level/src/Entities.hs 19_story/src/Entities.hs</pre>
<pre class="diffpre delete">--- 18_multi_level/src/Entities.hs</pre>
<pre class="diffpre insert">+++ 19_story/src/Entities.hs</pre>
<pre class="diffpre info">@@ -23,9 +23,12 @@</pre>
<pre class="diffpre context">            , (E.Bug       , (25,  3), Nothing)</pre>
<pre class="diffpre context">            , (E.Snake     , (38,  4), Nothing)</pre>
<pre class="diffpre context">            , (E.Dark      , (43, 11), Nothing)</pre>
<pre class="diffpre delete">-</pre>
<pre class="diffpre context">            , (E.Stairs    , (56, 44), Just "s")</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+           , (E.PotionDark , (16, 46), Just "pd")</pre>
<pre class="diffpre insert">+           , (E.PotionLight, ( 8, 46), Just "pl")</pre>
<pre class="diffpre insert">+           , (E.Key        , (54, 45), Just "ke")</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">            ]</pre>
<pre class="diffpre context">   in</pre>
<pre class="diffpre context">   let mkData (typ, pos@(x, y), l) (tiles', entities', loads') =</pre>
</div>
<h2 class=".diffh2">
src/EntityType.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b -r --new-file 18_multi_level/src/EntityType.hs 19_story/src/EntityType.hs</pre>
<pre class="diffpre delete">--- 18_multi_level/src/EntityType.hs</pre>
<pre class="diffpre insert">+++ 19_story/src/EntityType.hs</pre>
<pre class="diffpre info">@@ -14,6 +14,9 @@</pre>
<pre class="diffpre context">                 | Snake</pre>
<pre class="diffpre context">                 | Dark</pre>
<pre class="diffpre context">                 | Stairs</pre>
<pre class="diffpre insert">+                | PotionDark</pre>
<pre class="diffpre insert">+                | PotionLight</pre>
<pre class="diffpre insert">+                | Key</pre>
<pre class="diffpre context">                 | Unknown</pre>
<pre class="diffpre context">                 deriving (Show, Eq, Ord)</pre>
<pre class="diffpre context"> </pre>
</div>
<h2 class=".diffh2">
src/GameCore.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b -r --new-file 18_multi_level/src/GameCore.hs 19_story/src/GameCore.hs</pre>
<pre class="diffpre delete">--- 18_multi_level/src/GameCore.hs</pre>
<pre class="diffpre insert">+++ 19_story/src/GameCore.hs</pre>
<pre class="diffpre info">@@ -99,7 +97,7 @@</pre>
<pre class="diffpre context"> data Level = Level { _lvlName :: !Text</pre>
<pre class="diffpre context">                    , _lvlBoot :: !(World -&gt; World)</pre>
<pre class="diffpre context">                    , _lvlMapText :: !Text</pre>
<pre class="diffpre delete">-                   , _lvlTryMove :: !([Actor] -&gt; Maybe E.EntityType -&gt; World -&gt; WorldPos -&gt; Actor -&gt; [RogueAction])</pre>
<pre class="diffpre insert">+                   , _lvlStoryHandler :: !StoryHandler</pre>
<pre class="diffpre context">                    }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre info">@@ -107,17 +104,32 @@</pre>
<pre class="diffpre context"> data Levels = Levels01</pre>
<pre class="diffpre context">             | Levels02</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-</pre>
<pre class="diffpre context"> newtype WorldPos = WorldPos (Int, Int) deriving (Show, Eq, Ord)</pre>
<pre class="diffpre context"> newtype PlayerPos = PlayerPos (Int, Int) deriving (Show, Eq, Ord)</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+type StoryHandler = World -&gt; RogueEvent -&gt; [RogueAction]</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data RogueAction = ActMovePlayer (Int, Int)</pre>
<pre class="diffpre context">                  | ActMoveActor Actor WorldPos</pre>
<pre class="diffpre context">                  | ActSetPlayerViewPortStyle ViewPortStyle</pre>
<pre class="diffpre context">                  | ActTogglePlayerProp Text Text</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+                 | ActClearPlayerProp Text</pre>
<pre class="diffpre insert">+                 | ActSetPlayerProp Text Text</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">                  | ActGotoLevel Levels</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+                 | ActSetStoryHandler StoryHandler</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+                 | ActRemoveEntity E.EntityType WorldPos</pre>
<pre class="diffpre insert">+                 | ActReplaceEntity E.EntityType WorldPos Entity</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+data RogueEvent = EvtMove [Actor] (Maybe E.EntityType) WorldPos Actor</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> data ViewPortStyle = ViewPortCentre</pre>
<pre class="diffpre context">                    | ViewPortLock PlayerPos</pre>
</div>
<h2 class=".diffh2">
src/GameEngine.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b -r --new-file 18_multi_level/src/GameEngine.hs 19_story/src/GameEngine.hs</pre>
<pre class="diffpre delete">--- 18_multi_level/src/GameEngine.hs</pre>
<pre class="diffpre insert">+++ 19_story/src/GameEngine.hs</pre>
<pre class="diffpre info">@@ -432,6 +432,13 @@</pre>
<pre class="diffpre context">       world &amp; (wdPlayer . plActor . acProps) %~ Map.alter (toggleMapProp valEnabled) prop</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+    ActSetPlayerProp prop valEnabled -&gt;</pre>
<pre class="diffpre insert">+      world &amp; (wdPlayer . plActor . acProps) %~ Map.insert prop valEnabled</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    ActClearPlayerProp prop -&gt;</pre>
<pre class="diffpre insert">+      world &amp; (wdPlayer . plActor . acProps) %~ Map.delete prop</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">     ActMoveActor actor worldPos -&gt;</pre>
<pre class="diffpre context">       let</pre>
<pre class="diffpre context">         movedActor = actor &amp; acWorldPos .~ worldPos</pre>
<pre class="diffpre info">@@ -451,11 +456,33 @@</pre>
<pre class="diffpre context">         l</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+    ActSetStoryHandler h -&gt;</pre>
<pre class="diffpre insert">+      world &amp; (wdLevel . lvlStoryHandler) .~ h</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    ActRemoveEntity existingType atWorldPos -&gt;</pre>
<pre class="diffpre insert">+      world &amp; wdMap %~ Map.alter (deleteMapEntity existingType) atWorldPos</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    ActReplaceEntity existingType atWorldPos newEntity -&gt;</pre>
<pre class="diffpre insert">+      world &amp; wdMap %~ Map.alter (alterMapEntity existingType newEntity) atWorldPos</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context">   where</pre>
<pre class="diffpre context">     toggleMapProp v Nothing = Just v</pre>
<pre class="diffpre context">     toggleMapProp _ (Just _) = Nothing</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+    alterMapEntity :: E.EntityType -&gt; Entity -&gt; Maybe Entity -&gt; Maybe Entity</pre>
<pre class="diffpre insert">+    alterMapEntity _ new Nothing = Just new</pre>
<pre class="diffpre insert">+    alterMapEntity oldType new (Just oldEntity) = if oldType == (oldEntity ^. enType) then Just new else Just oldEntity</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+    deleteMapEntity :: E.EntityType -&gt; Maybe Entity -&gt; Maybe Entity</pre>
<pre class="diffpre insert">+    deleteMapEntity _ Nothing = Nothing</pre>
<pre class="diffpre insert">+    deleteMapEntity oldType (Just oldEntity) = if oldType == (oldEntity ^. enType) then Nothing else Just oldEntity</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> tryMoveActor :: World -&gt; Actor -&gt; (Int, Int) -&gt; Maybe World</pre>
<pre class="diffpre context"> tryMoveActor world actor (dx, dy) =</pre>
<pre class="diffpre context">   let</pre>
<pre class="diffpre info">@@ -481,8 +508,10 @@</pre>
<pre class="diffpre context">       -- Actors at destination</pre>
<pre class="diffpre context">       destActors = filter (\a -&gt; a ^. acWorldPos == tryWorldTo') (getAllActors world)</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-      -- Get actions</pre>
<pre class="diffpre delete">-      actions = (world ^. wdLevel ^. lvlTryMove) destActors destEntityType world tryWorldTo' actor</pre>
<pre class="diffpre insert">+      -- Create move event</pre>
<pre class="diffpre insert">+      evt = EvtMove destActors destEntityType tryWorldTo' actor</pre>
<pre class="diffpre insert">+      -- Run even to get actions</pre>
<pre class="diffpre insert">+      actions = (world ^. wdLevel ^. lvlStoryHandler) world evt </pre>
<pre class="diffpre context">    in</pre>
<pre class="diffpre context">    Just $ runActions world actions </pre>
<pre class="diffpre context"> </pre>
</div>
<h2 class=".diffh2">
src/Levels/Level01.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b -r --new-file 18_multi_level/src/Levels/Level01.hs 19_story/src/Levels/Level01.hs</pre>
<pre class="diffpre delete">--- 18_multi_level/src/Levels/Level01.hs</pre>
<pre class="diffpre insert">+++ 19_story/src/Levels/Level01.hs</pre>
<pre class="diffpre info">@@ -1,7 +1,7 @@</pre>
<pre class="diffpre context"> {-# LANGUAGE NoImplicitPrelude #-}</pre>
<pre class="diffpre context"> {-# LANGUAGE OverloadedStrings #-}</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-module Levels.Level01 where</pre>
<pre class="diffpre insert">+module Levels.Level01 (mkLevel) where</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> import Protolude hiding (Map)</pre>
<pre class="diffpre context"> import qualified Data.Set as Set</pre>
<pre class="diffpre info">@@ -16,13 +16,16 @@</pre>
<pre class="diffpre context"> import qualified BoundedInt as B</pre>
<pre class="diffpre context"> import qualified UtilityBrain as UB</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> mkLevel :: Text -&gt; Level</pre>
<pre class="diffpre delete">-mkLevel mapData = Level { _lvlName = "L01"</pre>
<pre class="diffpre insert">+mkLevel mapText =</pre>
<pre class="diffpre insert">+  Level { _lvlName = "L01"</pre>
<pre class="diffpre context">                         , _lvlBoot = bootLevel </pre>
<pre class="diffpre delete">-                        , _lvlMapText = mapData</pre>
<pre class="diffpre delete">-                        , _lvlTryMove = tryMove</pre>
<pre class="diffpre insert">+        , _lvlMapText = mapText</pre>
<pre class="diffpre insert">+        , _lvlStoryHandler = storyWaitingForKey</pre>
<pre class="diffpre context">                         }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> bootLevel :: World -&gt; World</pre>
<pre class="diffpre context"> bootLevel w1 =</pre>
<pre class="diffpre context">   let</pre>
<pre class="diffpre info">@@ -66,13 +69,76 @@</pre>
<pre class="diffpre context">             }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-tryMove :: [Actor] -&gt; Maybe E.EntityType -&gt; World -&gt; WorldPos -&gt; Actor -&gt; [RogueAction]</pre>
<pre class="diffpre delete">-tryMove destActors destEntityType _ posTo movingActor =</pre>
<pre class="diffpre delete">-  -- Is the move allowed</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+storyCommon :: World -&gt; RogueEvent -&gt; [RogueAction]</pre>
<pre class="diffpre insert">+storyCommon world evt =</pre>
<pre class="diffpre insert">+  case evt of</pre>
<pre class="diffpre insert">+    EvtMove destActors destEntityType posTo movingActor -&gt;</pre>
<pre class="diffpre insert">+      let isPlayer = isPlayerMoving world movingActor in</pre>
<pre class="diffpre insert">+      case (isPlayer, destActors, destEntityType) of</pre>
<pre class="diffpre insert">+        (_, [], Just E.Blank) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre insert">+        (_, [], Just E.Door) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre insert">+        (_, [], Nothing) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+        -- Only the player can pickup potions. Set lights on</pre>
<pre class="diffpre insert">+        (True, [], Just E.PotionLight) -&gt; [ ActMoveActor movingActor posTo</pre>
<pre class="diffpre insert">+                                          , ActSetPlayerProp "debug:light" "on"</pre>
<pre class="diffpre insert">+                                          , ActRemoveEntity E.PotionLight posTo</pre>
<pre class="diffpre insert">+                                          ]</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+        -- Only the player can pickup potions. Set lights off</pre>
<pre class="diffpre insert">+        (True, [], Just E.PotionDark) -&gt; [ ActMoveActor movingActor posTo</pre>
<pre class="diffpre insert">+                                         , ActClearPlayerProp "debug:light"</pre>
<pre class="diffpre insert">+                                         , ActRemoveEntity E.PotionDark posTo</pre>
<pre class="diffpre insert">+                                         ]</pre>
<pre class="diffpre insert">+        _ -&gt; []</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+storyWaitingForKey :: World -&gt; RogueEvent -&gt; [RogueAction]</pre>
<pre class="diffpre insert">+storyWaitingForKey world evt =</pre>
<pre class="diffpre insert">+  case evt of</pre>
<pre class="diffpre insert">+    EvtMove destActors destEntityType posTo movingActor -&gt;</pre>
<pre class="diffpre insert">+      let isPlayer = isPlayerMoving world movingActor in</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+      case (isPlayer, destActors, destEntityType) of</pre>
<pre class="diffpre insert">+        -- Player picked up the key</pre>
<pre class="diffpre insert">+        (True, [], Just E.Key) -&gt;</pre>
<pre class="diffpre insert">+          [ ActMoveActor movingActor posTo</pre>
<pre class="diffpre insert">+          , ActSetStoryHandler storyDoorOpen</pre>
<pre class="diffpre insert">+          , ActRemoveEntity E.Key posTo</pre>
<pre class="diffpre insert">+          ] &lt;&gt;</pre>
<pre class="diffpre insert">+          -- Replace all closed doors with open ones</pre>
<pre class="diffpre insert">+          ((\closedDoorAt -&gt; ActReplaceEntity E.DoorClosed closedDoorAt $ E.getEntity E.Door) &lt;$&gt; findPos E.DoorClosed)</pre>
<pre class="diffpre insert">+                 </pre>
<pre class="diffpre insert">+        _ -&gt; storyCommon world evt</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  where</pre>
<pre class="diffpre insert">+    findPos :: E.EntityType -&gt; [WorldPos]</pre>
<pre class="diffpre insert">+    findPos et =</pre>
<pre class="diffpre insert">+      let</pre>
<pre class="diffpre insert">+        es = Map.toList $ world ^. wdMap</pre>
<pre class="diffpre insert">+        found = filter (\(_, e) -&gt; e ^. enType == et) es</pre>
<pre class="diffpre insert">+      in</pre>
<pre class="diffpre insert">+      fst &lt;$&gt; found</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+  </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+storyDoorOpen :: World -&gt; RogueEvent -&gt; [RogueAction]</pre>
<pre class="diffpre insert">+storyDoorOpen world evt =</pre>
<pre class="diffpre insert">+  case evt of</pre>
<pre class="diffpre insert">+    EvtMove destActors destEntityType posTo movingActor -&gt;</pre>
<pre class="diffpre context">   case (destActors, destEntityType) of</pre>
<pre class="diffpre delete">-    ([], Just E.Blank) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre delete">-    ([], Just E.Door) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre delete">-    ([], Nothing) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre insert">+        ([], Just E.Key) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre context">     (_, Just E.Stairs) -&gt; [ActGotoLevel Levels02]</pre>
<pre class="diffpre delete">-    _ -&gt; []</pre>
<pre class="diffpre insert">+        _ -&gt; storyCommon world evt</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre insert">+isPlayerMoving :: World -&gt; Actor -&gt; Bool</pre>
<pre class="diffpre insert">+isPlayerMoving w a =</pre>
<pre class="diffpre insert">+  w ^. wdPlayer ^. plActor ^. acId == a ^. acId</pre>
<pre class="diffpre context"> </pre>
</div>
<h2 class=".diffh2">
src/Levels/Level02.hs
</h2>
<div class="file-diff">
<pre class="diffpre difffile">diff -w -B -a -d -u -b -r --new-file 18_multi_level/src/Levels/Level02.hs 19_story/src/Levels/Level02.hs</pre>
<pre class="diffpre delete">--- 18_multi_level/src/Levels/Level02.hs</pre>
<pre class="diffpre insert">+++ 19_story/src/Levels/Level02.hs</pre>
<pre class="diffpre info">@@ -1,7 +1,7 @@</pre>
<pre class="diffpre context"> {-# LANGUAGE NoImplicitPrelude #-}</pre>
<pre class="diffpre context"> {-# LANGUAGE OverloadedStrings #-}</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-module Levels.Level02 where</pre>
<pre class="diffpre insert">+module Levels.Level02 (mkLevel)  where</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> import           Protolude</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre info">@@ -10,19 +10,22 @@</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> mkLevel :: Text -&gt; Level</pre>
<pre class="diffpre delete">-mkLevel mapData = Level { _lvlName = "L02"</pre>
<pre class="diffpre insert">+mkLevel mapText =</pre>
<pre class="diffpre insert">+  Level { _lvlName = "L02"</pre>
<pre class="diffpre context">                         , _lvlBoot = bootLevel </pre>
<pre class="diffpre delete">-                        , _lvlMapText = mapData</pre>
<pre class="diffpre delete">-                        , _lvlTryMove = tryMove</pre>
<pre class="diffpre insert">+        , _lvlMapText = mapText</pre>
<pre class="diffpre insert">+        , _lvlStoryHandler = storySimple</pre>
<pre class="diffpre context">                         }</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre insert">+</pre>
<pre class="diffpre context"> bootLevel :: World -&gt; World</pre>
<pre class="diffpre context"> bootLevel w = w</pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre context"> </pre>
<pre class="diffpre delete">-tryMove :: [Actor] -&gt; Maybe E.EntityType -&gt; World -&gt; WorldPos -&gt; Actor -&gt; [RogueAction]</pre>
<pre class="diffpre delete">-tryMove destActors destEntityType _ posTo movingActor =</pre>
<pre class="diffpre delete">-  -- Is the move allowed</pre>
<pre class="diffpre insert">+storySimple :: World -&gt; RogueEvent -&gt; [RogueAction]</pre>
<pre class="diffpre insert">+storySimple _ evt =</pre>
<pre class="diffpre insert">+  case evt of</pre>
<pre class="diffpre insert">+    EvtMove destActors destEntityType posTo movingActor -&gt;</pre>
<pre class="diffpre context">   case (destActors, destEntityType) of</pre>
<pre class="diffpre context">     ([], Just E.Blank) -&gt; [ActMoveActor movingActor posTo]</pre>
<pre class="diffpre context">     ([], Just E.Door) -&gt; [ActMoveActor movingActor posTo]</pre>
</div>
</div>
<h1 id="chapters-1">Chapters</h1>
<p><a href="../2018-04-02-haskell-rogue-like.html">start</a> <a href="2018-04-02-haskell-rogue-like_18.html">prev</a> <a href="2018-04-02-haskell-rogue-like_20.html">next</a></p>


        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          
          ga('create', 'UA-78428674-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
